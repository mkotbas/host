<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Denetim Formu (Bulut Destekli)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #008CBA; --primary-dark: #007B9A; --secondary: #64748b; --success: #16a34a; --success-light: #dcfce7; --warning: #eab308; --danger: #dc2626; --light: #f8fafc; --dark: #1e293b; --gray: #94a3b8; --border: #e2e8f0; --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); --transition: all 0.3s ease;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 14px; line-height: 1.6; color: var(--dark); background-color: #f1f5f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: var(--card-shadow); padding: 24px; margin-bottom: 24px; transition: var(--transition); }
        h2 { font-size: 20px; color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; }
        button, .btn-like-label { cursor: pointer; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; }
        button:disabled { background-color: var(--gray) !important; color: #fff !important; cursor: not-allowed; opacity: 0.7; }
        button i, .btn-like-label i { margin-right: 8px; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-warning { background-color: var(--warning); color: var(--dark); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .action-button { width: 100%; padding: 12px; font-size: 15px; margin: 10px 0 30px; border-radius: 10px; background-color: var(--primary); color: white; }
        .fide-item { margin-bottom: 28px; padding: 20px; border-radius: 12px; background-color: white; box-shadow: var(--card-shadow); transition: var(--transition); }
        .fide-item.question-removed { opacity: 0.6; background-color: #fafafa; }
        .fide-title-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px;}
        .fide-title-container p { font-weight: 600; margin: 0; flex-grow: 1; font-size: 16px; color: var(--dark); }
        .fide-title-container.question-completed p { color: var(--success); text-decoration: line-through; }
        .fide-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-right: 8px; background-color: var(--primary); color: white; }
        .static-item, .dynamic-input-item { display: flex; align-items: center; margin-bottom: 12px; padding: 12px; background-color: var(--light); border-radius: 8px; transition: all 0.3s ease; overflow: hidden; }
        .static-item .content { flex-grow: 1; transition: all 0.3s ease; }
        .dynamic-input-item input[type="text"] { flex-grow: 1; border: 1px solid var(--border); padding: 10px; border-radius: 6px; transition: all 0.3s ease;}
        .dynamic-input-item input[type="text"].completed { text-decoration: line-through; color: var(--success); background-color: var(--success-light); }
        .add-item-btn { background-color: var(--primary); color: white; }
        .status-btn { background-color: var(--success); color: white; margin-left: 10px; }
        .status-btn.undo { background-color: var(--warning); color: var(--dark); }
        .delete-bar { flex-shrink: 0; width: 32px; border-radius: 0 8px 8px 0; cursor: pointer; align-self: stretch; display: flex; align-items: center; justify-content: center; margin: -12px -12px -12px 15px; padding: 12px 0; }
        .product-adder { display: flex; gap: 10px; align-items: center; margin: 15px 0; }
        .product-adder select { flex-grow: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
        .product-adder input[type="number"] { width: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
        .selected-product-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background-color: var(--light); border-radius: 8px; margin-bottom: 8px; }
        .delete-item-btn { background-color: var(--danger); color: white; margin-left:10px;}
        .delete-item-btn i { margin-right: 0; }
        textarea { width: 100%; padding: 16px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; margin-bottom: 16px; }
        .file-input-wrapper { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 1rem; }
        .file-input-wrapper input[type="file"] { display: none; }
        .file-input-label { background-color: var(--primary); color: white; padding: 6px 12px; font-size: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; transition: var(--transition); }
        #file-name, #fide-file-name { font-style: italic; color: var(--dark); }
        #store-selection-area { display: none; margin-top: 20px; }
        #store-search-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 12px; font-size: 16px; }
        #store-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 5px; }
        .store-item { padding: 10px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; }
        .store-item:hover { background-color: #f1f5f9; }
        .store-item.selected { background-color: var(--success); color: white; font-weight: bold; }
        #clear-storage-btn, #clear-excel-btn, #clear-fide-excel-btn { display: none; }
        #initialization-error { display: none; color: #b91c1c; background-color: #fee2e2; border: 1px solid #f87171; }
        .top-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .backup-controls { display: flex; gap: 8px; flex-wrap: wrap; }
        .cloud-toggle-container { display: flex; align-items: center; gap: 10px; font-size: 12px; font-weight: 600;}
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--danger); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }
        .manager-item { border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 15px; background: white; }
        .manager-item-grid { display: grid; grid-template-columns: 80px 1fr 120px; gap: 10px; align-items: center; }
        .manager-item label { font-weight: 600; display: block; margin-bottom: 5px; font-size: 12px; color: var(--secondary); }
        .manager-item input, .manager-item select, .manager-item textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 10px; }
        .manager-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom:20px; border-bottom: 1px solid var(--border); }
        .manager-item-footer { display: flex; justify-content: flex-end; }
        .pop-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 5px; }
        .checkbox-label { display: flex; align-items: center; padding: 5px; font-size: 14px; cursor: pointer; justify-content: center; border: 1px solid #ddd; border-radius: 4px; background-color: #f9f9f9; }
        .pop-checkbox { margin-right: 5px; }
        .pop-button-container { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .warning-message { color: #d32f2f; background-color: #ffebee; border: 1px solid #d32f2f; border-radius: 4px; padding: 10px; margin-top: 10px; text-align: center; font-weight: bold; display: none; }
        
        /* E-posta taslağı için ek stiller */
        #email-draft-area ul { 
            list-style-type: disc; 
            margin: 16px 0; 
            padding-left: 40px; 
        }
        #email-draft-area li { 
            margin-bottom: 10px; 
            padding-left: 8px; 
        }
        #email-draft-area p { 
            margin-bottom: 1em; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-controls">
            <div class="backup-controls">
                <button id="backup-btn" class="btn-primary btn-sm"><i class="fas fa-cloud-download-alt"></i> Tüm Raporları Yedekle</button>
                <label for="restore-file-input" class="btn-like-label btn-success btn-sm"><i class="fas fa-cloud-upload-alt"></i> Yedekten Yükle</label>
                <input type="file" id="restore-file-input" accept=".json" style="display: none;">
                <label for="merge-file-input" class="btn-like-label btn-warning btn-sm"><i class="fas fa-compress-arrows-alt"></i> Yedekleri Birleştir</label>
                <input type="file" id="merge-file-input" accept=".json" style="display: none;" multiple>
            </div>
            <div class="cloud-toggle-container">
                <span id="cloud-status-text">Bulut Kapalı</span>
                <label class="switch">
                    <input type="checkbox" id="cloud-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <button id="toggle-manager-btn" class="btn-warning btn-sm"><i class="fas fa-edit"></i> Soru Yöneticisi</button>
        </div>
        
        <div class="card" id="question-manager" style="display: none;">
            <h2><i class="fas fa-cogs"></i> FiDe Soru Yöneticisi</h2>
            <p style="font-size: 12px; color: var(--secondary); margin-top: -15px; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Buradan FİDE sorularını düzenleyin...</p>
            <div class="manager-actions">
                <button onclick="saveQuestions()" class="btn-success"><i class="fas fa-save"></i> Değişiklikleri Kaydet ve Dosyayı İndir</button>
                <button onclick="addNewQuestionUI()" class="btn-primary"><i class="fas fa-plus"></i> Yeni Soru Ekle</button>
            </div>
            <div id="manager-list"></div>
        </div>

        <div class="card" id="dide-upload-card">
            <h2><i class="fas fa-chart-line"></i> Puan Entegrasyonu ve Veri Yönetimi</h2>
            <p style="font-size: 12px; color: var(--secondary); margin-top: -15px; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Raporlarınız artık bulutta saklanıyor. Manuel yedekleme butonları ek güvenlik için korunmuştur.</p>
            <div>
                <p><b>1. Adım: DiDe Puan Excel Dosyasını Yükleyin</b></p>
                <div class="file-input-wrapper"><label for="excel-file-input" class="file-input-label btn-sm"><i class="fas fa-file-excel"></i> DiDe Excel'i Seç</label><input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display: none;"><span id="file-name">Henüz dosya seçilmedi.</span></div>
            </div>
            <div style="margin-top: 20px;">
                <p><b>2. Adım: FiDe Puan Excel Dosyasını Yükleyin</b></p>
                <div class="file-input-wrapper"><label for="fide-excel-file-input" class="file-input-label btn-sm"><i class="fas fa-file-excel"></i> FiDe Excel'i Seç</label><input type="file" id="fide-excel-file-input" accept=".xlsx, .xls" style="display: none;"><span id="fide-file-name">Henüz dosya seçilmedi.</span></div>
            </div>
            <div style="margin-top: 20px;">
                <p><b>3. Adım: Mağaza Seçimi</b></p>
                <div id="store-selection-area">
                    <input type="text" id="store-search-input" placeholder="Mağaza ara...">
                    <div id="store-list"></div>
                </div>
            </div>
        </div>

        <div class="card" id="initialization-error">
            <h2><i class="fas fa-exclamation-triangle"></i> Firebase Bağlantı Hatası</h2>
            <p>Firebase bağlantısı kurulamadı. Lütfen internet bağlantınızı kontrol edip sayfayı yenileyin.</p>
        </div>

        <div class="card" id="fide-form-card">
            <h2><i class="fas fa-clipboard-check"></i> FiDe Denetim Formu</h2>
            <div id="fide-form"></div>
        </div>

        <div class="card" id="email-draft-card">
            <h2><i class="fas fa-envelope"></i> E-posta Taslağı</h2>
            <div id="email-draft-area" style="background-color: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb;">
                <p>Denetim tamamlandıktan sonra e-posta taslağı burada görünecektir.</p>
            </div>
            <button id="copy-email-btn" class="btn-primary" style="width: 100%; padding: 12px; font-size: 15px; margin-bottom: 10px;" disabled><i class="fas fa-copy"></i> E-postayı Kopyala</button>
            <button id="download-report-btn" class="btn-success" style="width: 100%; padding: 12px; font-size: 15px;" disabled><i class="fas fa-download"></i> Raporu İndir</button>
        </div>
    </div>

    <script>
        // Firebase konfigürasyonu
        const firebaseConfig = {
            apiKey: "AIzaSyDvQ1p1uXz1p2Qp2Qp2Qp2Qp2Qp2Qp2Qp2Q",
            authDomain: "fide-denetim-formu.firebaseapp.com",
            databaseURL: "https://fide-denetim-formu-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fide-denetim-formu",
            storageBucket: "fide-denetim-formu.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Firebase'i başlat
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM elementleri
        const fideForm = document.getElementById('fide-form');
        const emailDraftArea = document.getElementById('email-draft-area');
        const copyEmailBtn = document.getElementById('copy-email-btn');
        const downloadReportBtn = document.getElementById('download-report-btn');
        const excelFileInput = document.getElementById('excel-file-input');
        const fideExcelFileInput = document.getElementById('fide-excel-file-input');
        const fileName = document.getElementById('file-name');
        const fideFileName = document.getElementById('fide-file-name');
        const storeSelectionArea = document.getElementById('store-selection-area');
        const storeSearchInput = document.getElementById('store-search-input');
        const storeList = document.getElementById('store-list');
        const cloudToggle = document.getElementById('cloud-toggle');
        const cloudStatusText = document.getElementById('cloud-status-text');
        const backupBtn = document.getElementById('backup-btn');
        const restoreFileInput = document.getElementById('restore-file-input');
        const mergeFileInput = document.getElementById('merge-file-input');
        const questionManager = document.getElementById('question-manager');
        const toggleManagerBtn = document.getElementById('toggle-manager-btn');
        const managerList = document.getElementById('manager-list');
        const initializationError = document.getElementById('initialization-error');

        // Global değişkenler
        let questions = [];
        let storeData = [];
        let fideStoreData = [];
        let selectedStore = null;
        let userReports = [];
        let cloudEnabled = true;

        // Sayfa yüklendiğinde
        window.addEventListener('load', () => {
            // Soruları yükle
            loadQuestions();
            
            // Kullanıcı raporlarını yükle
            loadUserReports();
            
            // Firebase bağlantısını kontrol et
            checkFirebaseConnection();
        });

        // Firebase bağlantısını kontrol et
        function checkFirebaseConnection() {
            const connectedRef = firebase.database().ref(".info/connected");
            connectedRef.on("value", function(snap) {
                if (snap.val() === true) {
                    console.log("Firebase bağlantısı başarılı");
                    initializationError.style.display = 'none';
                } else {
                    console.log("Firebase bağlantısı yok");
                    initializationError.style.display = 'block';
                }
            });
        }

        // Soruları yükle
        function loadQuestions() {
            // Önce localStorage'dan yükle
            const savedQuestions = localStorage.getItem('fideQuestions');
            
            if (savedQuestions) {
                questions = JSON.parse(savedQuestions);
                renderFideForm();
                renderManagerList();
            } else {
                // Varsayılan soruları yükle
                fetch('fide_questions.json')
                    .then(response => response.json())
                    .then(data => {
                        questions = data;
                        localStorage.setItem('fideQuestions', JSON.stringify(questions));
                        renderFideForm();
                        renderManagerList();
                    })
                    .catch(error => {
                        console.error('Soru dosyası yüklenirken hata oluştu:', error);
                        // Varsayılan sorular
                        questions = [
                            { id: 1, text: "Ürün çeşitliliği yeterli mi?", category: "Ürün Çeşitliliği", completed: false, removed: false },
                            { id: 2, text: "Raflar düzenli ve temiz mi?", category: "Raflar", completed: false, removed: false },
                            { id: 3, text: "Fiyat etiketleri doğru ve okunaklı mı?", category: "Fiyatlandırma", completed: false, removed: false }
                        ];
                        localStorage.setItem('fideQuestions', JSON.stringify(questions));
                        renderFideForm();
                        renderManagerList();
                    });
            }
        }

        // Kullanıcı raporlarını yükle
        function loadUserReports() {
            const savedReports = localStorage.getItem('userReports');
            if (savedReports) {
                userReports = JSON.parse(savedReports);
            }
        }

        // FiDe formunu oluştur
        function renderFideForm() {
            fideForm.innerHTML = '';
            
            // Kategorilere göre gruplandır
            const categories = {};
            questions.forEach(q => {
                if (q.removed) return;
                if (!categories[q.category]) {
                    categories[q.category] = [];
                }
                categories[q.category].push(q);
            });
            
            // Her kategori için HTML oluştur
            for (const category in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'fide-category';
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = category;
                categoryTitle.style.marginTop = '20px';
                categoryTitle.style.marginBottom = '15px';
                categoryTitle.style.color = 'var(--primary)';
                categoryTitle.style.borderBottom = '2px solid var(--border)';
                categoryTitle.style.paddingBottom = '8px';
                
                categoryDiv.appendChild(categoryTitle);
                
                categories[category].forEach(question => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = `fide-item ${question.completed ? 'question-completed' : ''}`;
                    questionDiv.id = `question-${question.id}`;
                    
                    const titleContainer = document.createElement('div');
                    titleContainer.className = `fide-title-container ${question.completed ? 'question-completed' : ''}`;
                    
                    const questionText = document.createElement('p');
                    questionText.textContent = question.text;
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'fide-actions';
                    
                    const completeBtn = document.createElement('button');
                    completeBtn.className = question.completed ? 'status-btn undo' : 'status-btn';
                    completeBtn.innerHTML = question.completed ? '<i class="fas fa-undo"></i> Geri Al' : '<i class="fas fa-check"></i> Tamamlandı';
                    completeBtn.onclick = () => toggleQuestionStatus(question.id);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'delete-item-btn';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    removeBtn.onclick = () => removeQuestion(question.id);
                    
                    actionsDiv.appendChild(completeBtn);
                    actionsDiv.appendChild(removeBtn);
                    
                    titleContainer.appendChild(questionText);
                    questionDiv.appendChild(titleContainer);
                    questionDiv.appendChild(actionsDiv);
                    
                    categoryDiv.appendChild(questionDiv);
                });
                
                fideForm.appendChild(categoryDiv);
            }
        }

        // Soru durumunu değiştir
        function toggleQuestionStatus(id) {
            const question = questions.find(q => q.id === id);
            if (question) {
                question.completed = !question.completed;
                localStorage.setItem('fideQuestions', JSON.stringify(questions));
                renderFideForm();
            }
        }

        // Soruyu kaldır
        function removeQuestion(id) {
            const question = questions.find(q => q.id === id);
            if (question) {
                question.removed = true;
                localStorage.setItem('fideQuestions', JSON.stringify(questions));
                renderFideForm();
            }
        }

        // Excel dosyasını yükle
        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileName.textContent = file.name;
                readExcelFile(file, 'dide');
            }
        });

        // FiDe Excel dosyasını yükle
        fideExcelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fideFileName.textContent = file.name;
                readExcelFile(file, 'fide');
            }
        });

        // Excel dosyasını oku
        function readExcelFile(file, type) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // İlk sayfayı al
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (type === 'dide') {
                    storeData = jsonData;
                    processStoreData();
                } else if (type === 'fide') {
                    fideStoreData = jsonData;
                    processFideStoreData();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Mağaza verilerini işle
        function processStoreData() {
            // Başlık satırını kaldır
            storeData.shift();
            
            // Mağaza seçim alanını göster
            storeSelectionArea.style.display = 'block';
            
            // Mağaza listesini oluştur
            renderStoreList();
        }

        // FiDe mağaza verilerini işle
        function processFideStoreData() {
            // Başlık satırını kaldır
            fideStoreData.shift();
        }

        // Mağaza listesini oluştur
        function renderStoreList() {
            storeList.innerHTML = '';
            
            const searchText = storeSearchInput.value.toLowerCase();
            
            storeData.forEach((store, index) => {
                if (store.length < 2) return;
                
                const storeName = store[1] || '';
                const storeCode = store[0] || '';
                
                if (storeName.toLowerCase().includes(searchText) || storeCode.toLowerCase().includes(searchText)) {
                    const storeItem = document.createElement('div');
                    storeItem.className = 'store-item';
                    storeItem.textContent = `${storeCode} - ${storeName}`;
                    storeItem.dataset.index = index;
                    
                    storeItem.addEventListener('click', () => {
                        // Tüm mağaza öğelerinden seçimi kaldır
                        document.querySelectorAll('.store-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // Seçilen mağazayı işaretle
                        storeItem.classList.add('selected');
                        
                        // Seçilen mağazayı kaydet
                        selectedStore = store;
                        
                        // E-posta taslağını güncelle
                        generateEmail();
                    });
                    
                    storeList.appendChild(storeItem);
                }
            });
        }

        // Mağaza arama
        storeSearchInput.addEventListener('input', renderStoreList);

        // E-posta taslağı oluştur
        function generateEmail() {
            if (!selectedStore) {
                emailDraftArea.innerHTML = '<p>Lütfen önce bir mağaza seçin.</p>';
                copyEmailBtn.disabled = true;
                downloadReportBtn.disabled = true;
                return;
            }
            
            const storeCode = selectedStore[0] || '';
            const storeName = selectedStore[1] || '';
            const managerName = selectedStore[2] || '';
            const managerEmail = selectedStore[3] || '';
            
            // Tamamlanan ve tamamlanmayan soruları say
            const completedQuestions = questions.filter(q => !q.removed && q.completed);
            const incompleteQuestions = questions.filter(q => !q.removed && !q.completed);
            
            // Kategorilere göre gruplandır
            const completedByCategory = {};
            const incompleteByCategory = {};
            
            completedQuestions.forEach(q => {
                if (!completedByCategory[q.category]) completedByCategory[q.category] = [];
                completedByCategory[q.category].push(q);
            });
            
            incompleteQuestions.forEach(q => {
                if (!incompleteByCategory[q.category]) incompleteByCategory[q.category] = [];
                incompleteByCategory[q.category].push(q);
            });
            
            // E-posta içeriğini oluştur
            let emailContent = `
                <p><strong>Mağaza Kodu:</strong> ${storeCode}</p>
                <p><strong>Mağaza Adı:</strong> ${storeName}</p>
                <p><strong>Mağaza Müdürü:</strong> ${managerName}</p>
                <p><strong>E-posta:</strong> ${managerEmail}</p>
                <br>
                <p>Sayın ${managerName},</p>
                <p>Mağazanızda gerçekleştirilen FiDe denetim sonuçları aşağıda özetlenmiştir:</p>
                <br>
            `;
            
            // Tamamlanan maddeler
            if (completedQuestions.length > 0) {
                emailContent += `<p><strong>Uygun Bulunan Konular:</strong></p>`;
                emailContent += `<ul>`;
                
                for (const category in completedByCategory) {
                    emailContent += `<li><strong>${category}:</strong>`;
                    emailContent += `<ul>`;
                    completedByCategory[category].forEach(q => {
                        emailContent += `<li>${q.text}</li>`;
                    });
                    emailContent += `</ul>`;
                    emailContent += `</li>`;
                }
                
                emailContent += `</ul>`;
                emailContent += `<br>`;
            }
            
            // Eksik maddeler
            if (incompleteQuestions.length > 0) {
                emailContent += `<p><strong>Eksik/Geliştirme Gereken Konular:</strong></p>`;
                emailContent += `<ul>`;
                
                for (const category in incompleteByCategory) {
                    emailContent += `<li><strong>${category}:</strong>`;
                    emailContent += `<ul>`;
                    incompleteByCategory[category].forEach(q => {
                        emailContent += `<li>${q.text}</li>`;
                    });
                    emailContent += `</ul>`;
                    emailContent += `</li>`;
                }
                
                emailContent += `</ul>`;
                emailContent += `<br>`;
            }
            
            emailContent += `
                <p>Eksikliklerin giderilmesi ve mağaza standartlarımızın sürdürülebilirliği için gerekli çalışmaları yapmanızı rica ederiz.</p>
                <br>
                <p>Saygılarımızla,<br>Retail Operasyon Ekibi</p>
            `;
            
            emailDraftArea.innerHTML = emailContent;
            copyEmailBtn.disabled = false;
            downloadReportBtn.disabled = false;
            
            // Raporu kaydet
            saveReport(storeCode, storeName, managerName, managerEmail, completedQuestions, incompleteQuestions);
        }

        // Raporu kaydet
        function saveReport(storeCode, storeName, managerName, managerEmail, completed, incomplete) {
            const report = {
                id: Date.now(),
                date: new Date().toISOString(),
                storeCode,
                storeName,
                managerName,
                managerEmail,
                completed,
                incomplete
            };
            
            // Mevcut raporları kontrol et ve aynı mağaza için güncelle
            const existingIndex = userReports.findIndex(r => r.storeCode === storeCode);
            
            if (existingIndex !== -1) {
                userReports[existingIndex] = report;
            } else {
                userReports.push(report);
            }
            
            localStorage.setItem('userReports', JSON.stringify(userReports));
            
            // Bulut senkronizasyonu
            if (cloudEnabled) {
                syncToCloud(report);
            }
        }

        // Buluta senkronize et
        function syncToCloud(report) {
            const userId = getUserId();
            if (!userId) return;
            
            const reportRef = database.ref(`users/${userId}/reports/${report.id}`);
            reportRef.set(report)
                .then(() => console.log('Rapor buluta kaydedildi'))
                .catch(error => console.error('Bulut kaydı hatası:', error));
        }

        // Kullanıcı ID'sini al
        function getUserId() {
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }
            return userId;
        }

        // E-postayı kopyala
        copyEmailBtn.addEventListener('click', () => {
            const range = document.createRange();
            range.selectNode(emailDraftArea);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            
            // Kullanıcıya bildir
            const originalText = copyEmailBtn.innerHTML;
            copyEmailBtn.innerHTML = '<i class="fas fa-check"></i> Kopyalandı!';
            setTimeout(() => {
                copyEmailBtn.innerHTML = originalText;
            }, 2000);
        });

        // Raporu indir
        downloadReportBtn.addEventListener('click', () => {
            if (!selectedStore) return;
            
            const storeCode = selectedStore[0] || '';
            const storeName = selectedStore[1] || '';
            
            const reportData = {
                storeCode,
                storeName,
                date: new Date().toLocaleDateString('tr-TR'),
                content: emailDraftArea.innerHTML
            };
            
            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fide_rapor_${storeCode}_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Bulut senkronizasyonunu aç/kapa
        cloudToggle.addEventListener('change', () => {
            cloudEnabled = cloudToggle.checked;
            cloudStatusText.textContent = cloudEnabled ? 'Bulut Açık' : 'Bulut Kapalı';
            
            if (cloudEnabled) {
                // Tüm raporları senkronize et
                userReports.forEach(report => {
                    syncToCloud(report);
                });
            }
        });

        // Yedekleme butonu
        backupBtn.addEventListener('click', () => {
            const backupData = {
                questions: questions,
                reports: userReports,
                backupDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fide_yedek_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Yedekten yükle
        restoreFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (backupData.questions) {
                        questions = backupData.questions;
                        localStorage.setItem('fideQuestions', JSON.stringify(questions));
                    }
                    
                    if (backupData.reports) {
                        userReports = backupData.reports;
                        localStorage.setItem('userReports', JSON.stringify(userReports));
                    }
                    
                    renderFideForm();
                    renderManagerList();
                    
                    alert('Yedekleme başarıyla yüklendi!');
                } catch (error) {
                    alert('Yedek dosyası okunurken hata oluştu: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        // Yedekleri birleştir
        mergeFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (!files.length) return;
            
            let mergedReports = [...userReports];
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (backupData.reports) {
                            backupData.reports.forEach(report => {
                                const existingIndex = mergedReports.findIndex(r => r.id === report.id);
                                if (existingIndex === -1) {
                                    mergedReports.push(report);
                                }
                            });
                        }
                        
                        userReports = mergedReports;
                        localStorage.setItem('userReports', JSON.stringify(userReports));
                        
                        alert('Yedekler başarıyla birleştirildi!');
                    } catch (error) {
                        alert('Yedek dosyası okunurken hata oluştu: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
        });

        // Soru yöneticisini göster/gizle
        toggleManagerBtn.addEventListener('click', () => {
            if (questionManager.style.display === 'none') {
                questionManager.style.display = 'block';
                toggleManagerBtn.innerHTML = '<i class="fas fa-times"></i> Soru Yöneticisini Kapat';
                toggleManagerBtn.classList.add('btn-danger');
            } else {
                questionManager.style.display = 'none';
                toggleManagerBtn.innerHTML = '<i class="fas fa-edit"></i> Soru Yöneticisi';
                toggleManagerBtn.classList.remove('btn-danger');
            }
        });

        // Yönetici listesini oluştur
        function renderManagerList() {
            managerList.innerHTML = '';
            
            // Kategorilere göre gruplandır
            const categories = {};
            questions.forEach(q => {
                if (!categories[q.category]) {
                    categories[q.category] = [];
                }
                categories[q.category].push(q);
            });
            
            // Her kategori için HTML oluştur
            for (const category in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'manager-item';
                
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = category;
                categoryTitle.style.marginBottom = '15px';
                categoryTitle.style.color = 'var(--primary)';
                
                categoryDiv.appendChild(categoryTitle);
                
                categories[category].forEach(question => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'manager-item-grid';
                    
                    // ID
                    const idDiv = document.createElement('div');
                    idDiv.innerHTML = `<label>ID</label><input type="text" value="${question.id}" readonly>`;
                    
                    // Soru metni
                    const textDiv = document.createElement('div');
                    textDiv.innerHTML = `<label>Soru Metni</label><textarea rows="2">${question.text}</textarea>`;
                    
                    // İşlemler
                    const actionsDiv = document.createElement('div');
                    actionsDiv.innerHTML = `
                        <label>İşlemler</label>
                        <div>
                            <button onclick="updateQuestion(${question.id}, this)" class="btn-primary btn-sm" style="margin-bottom: 5px;"><i class="fas fa-save"></i> Güncelle</button>
                            <button onclick="deleteQuestion(${question.id})" class="btn-danger btn-sm"><i class="fas fa-trash"></i> Sil</button>
                        </div>
                    `;
                    
                    questionDiv.appendChild(idDiv);
                    questionDiv.appendChild(textDiv);
                    questionDiv.appendChild(actionsDiv);
                    
                    categoryDiv.appendChild(questionDiv);
                });
                
                managerList.appendChild(categoryDiv);
            }
        }

        // Yeni soru ekle UI
        function addNewQuestionUI() {
            const newId = questions.length > 0 ? Math.max(...questions.map(q => q.id)) + 1 : 1;
            
            const newQuestionDiv = document.createElement('div');
            newQuestionDiv.className = 'manager-item';
            newQuestionDiv.innerHTML = `
                <h3>Yeni Soru Ekle</h3>
                <div class="manager-item-grid">
                    <div>
                        <label>ID</label>
                        <input type="text" value="${newId}" readonly>
                    </div>
                    <div>
                        <label>Kategori</label>
                        <input type="text" id="new-question-category" placeholder="Kategori adı">
                    </div>
                    <div>
                        <label>İşlemler</label>
                        <div>
                            <button onclick="addNewQuestion(${newId})" class="btn-success btn-sm"><i class="fas fa-plus"></i> Ekle</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <label>Soru Metni</label>
                    <textarea id="new-question-text" rows="3" placeholder="Soru metnini yazın"></textarea>
                </div>
            `;
            
            managerList.prepend(newQuestionDiv);
        }

        // Yeni soru ekle
        function addNewQuestion(id) {
            const categoryInput = document.getElementById('new-question-category');
            const textInput = document.getElementById('new-question-text');
            
            const category = categoryInput.value.trim();
            const text = textInput.value.trim();
            
            if (!category || !text) {
                alert('Lütfen kategori ve soru metnini girin.');
                return;
            }
            
            const newQuestion = {
                id: id,
                text: text,
                category: category,
                completed: false,
                removed: false
            };
            
            questions.push(newQuestion);
            localStorage.setItem('fideQuestions', JSON.stringify(questions));
            
            renderFideForm();
            renderManagerList();
        }

        // Soruyu güncelle
        function updateQuestion(id, button) {
            const questionDiv = button.closest('.manager-item-grid');
            const textarea = questionDiv.querySelector('textarea');
            const newText = textarea.value.trim();
            
            if (!newText) {
                alert('Soru metni boş olamaz.');
                return;
            }
            
            const question = questions.find(q => q.id === id);
            if (question) {
                question.text = newText;
                localStorage.setItem('fideQuestions', JSON.stringify(questions));
                renderFideForm();
                
                // Kullanıcıya bildir
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Güncellendi!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            }
        }

        // Soruyu sil
        function deleteQuestion(id) {
            if (!confirm('Bu soruyu silmek istediğinize emin misiniz?')) return;
            
            const questionIndex = questions.findIndex(q => q.id === id);
            if (questionIndex !== -1) {
                questions.splice(questionIndex, 1);
                localStorage.setItem('fideQuestions', JSON.stringify(questions));
                renderFideForm();
                renderManagerList();
            }
        }

        // Soruları kaydet ve indir
        function saveQuestions() {
            const dataStr = JSON.stringify(questions, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fide_questions.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>