<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Denetim Formu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <link rel="stylesheet" href="fidecss.css">

    <script>
        // Firebase projenizin yapılandırma bilgilerini buraya yapıştırın
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Firebase'i başlat
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
    </script>

</head>
<body>
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>İşlem yapılıyor, lütfen bekleyin...</p>
    </div>

    <div class="container">
        
        <div class="top-controls">
            <div class="backup-controls">
                <button id="toggle-manager-btn" class="btn-warning btn-sm"><i class="fas fa-edit"></i> Soru Yöneticisi</button>
                <div class="dropdown-container">
                    <button id="backup-menu-btn" class="btn-primary btn-sm">
                        <i class="fas fa-archive"></i> Yedekleme <i class="fas fa-caret-down"></i>
                    </button>
                    <div id="backup-dropdown" class="dropdown-content">
                        <a href="#" id="export-json-btn"><i class="fas fa-file-download"></i> JSON İndir</a>
                        <a href="#" id="import-json-link"><i class="fas fa-file-upload"></i> JSON Yükle</a>
                        <input type="file" id="import-json-input" style="display: none;" accept=".json">
                    </div>
                </div>
                 <button id="upload-emails-btn" class="btn-secondary btn-sm"><i class="fas fa-cloud-upload-alt"></i> E-postaları Yükle</button>
            </div>
             <button id="email-draft-btn" class="btn-success"><i class="fas fa-envelope-open-text"></i> E-posta Taslağı Oluştur</button>
        </div>
        
        <div id="question-manager" class="card" style="display: none;">
            <h2 class="card-title">Soru ve Ürün Yöneticisi</h2>
            <div class="product-adder">
                <input type="text" id="product-selector" placeholder="Bayi Kodu veya Unvan Girin">
                <input type="number" id="product-qty" placeholder="Adet" value="1" min="1" style="display:none;">
                <button id="add-product-btn" class="btn-primary"><i class="fas fa-plus"></i> Bayi Ekle</button>
            </div>
            <div id="product-suggestions"></div>
            <div class="question-list-header">
                <h3>Eklenen Bayiler</h3>
            </div>
            <ul id="product-list" class="item-list"></ul>
            <button id="save-to-cloud-btn" class="btn-primary" style="width: 100%; margin-top: 15px;">
                <i class="fas fa-save"></i> Değişiklikleri Buluta Kaydet
            </button>
        </div>
        
        <div id="form-content"></div>
    </div>

    <div id="email-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>E-posta Taslağı</h2>
            <p style="font-size: 13px; color: #666;">Aşağıdaki içerik, "Tamamlandı" olarak işaretlenen maddelerden otomatik olarak oluşturulmuştur. Kopyalayıp e-posta istemcinize yapıştırabilirsiniz.</p>
            <div id="email-output" contenteditable="true" class="email-body"></div>
            <button id="copy-email-btn" class="btn-primary btn-sm"><i class="fas fa-copy"></i> İçeriği Kopyala</button>
        </div>
    </div>

    <script>
        let allQuestionsData = {};
        let bayiEmailMappings = {}; // Bayi e-postalarını tutacak global değişken

        // SİZE AİT 202 ADET BAYİ KODU VE E-POSTA ADRESİ BURAYA EKLENDİ
        const melihsBayiData = {
            "22225123": "abdurrahim_kara@hotmail.com;",
            "22258008": "nurevaletleri@gmail.com;",
            "22269002": "bayhanlar.plaza@hotmail.com;",
            "22236114": "arasorhan36@gmail.com;",
            "22258013": "sivaskarinca58@hotmail.com;",
            "22236508": "msenaerdogdu@gmail.com;",
            "22229501": "arcelikgumushane@gmail.com;",
            "22258120": "arcelikzara@hotmail.com;",
            "22258012": "melihbalk@gmail.com;",
            "22225124": "oguz.yakupoglu@hotmail.com;",
            "22236505": "posofltd@hotmail.com;",
            "22275104": "demir.mustafa@hotmail.com;",
            "22224006": "ozdincler@hotmail.com;",
            "22224508": "erbirlik@gmail.com;",
            "22236005": "posofltd@hotmail.com;",
            "22225121": "halkalilar@gmail.com;",
            "22258002": "ugurkoll.arcelik@hotmail.com;",
            "22276004": "guvengida04@gmail.com;",
            "22225008": "rpayveren@hotmail.com;",
            "22204002": "arcelik_tastanlar_@hotmail.com;",
            "22225108": "cevdetyavuz.arcelik@gmail.com;",
            "22258121": "guventicaret_58@hotmail.com;",
            "22258119": "eren_demir_58@hotmail.com;",
            "22236008": "msenaerdogdu@gmail.com;",
            "22204003": "guneyarcelik@gmail.com;",
            "22225122": "adematila@hotmail.com;",
            "22269003": "tahaarcelik@gmail.com;",
            "22225516": "dadas.avm@hotmail.com;",
            "22225016": "dadas.avm@hotmail.com;",
            "22204109": "taslicaysahin@msn.com;",
            "22224012": "adem-emiroglu@hotmail.com;",
            "22258118": "m_atalay58@hotmail.com;",
            "22225011": "orhanhakanmir@gmail.com;",
            "22275002": "onursayin_75@hotmail.com;",
            "22258122": "gultekinler58@hotmail.com;",
            "22258502": "m_atalay58@hotmail.com;",
            "22224008": "erbirlik@gmail.com;",
            "22225103": "omerlutficeylan@hotmail.com;",
            "22258116": "fahrettinyilmaz@msn.com;",
            "22204118": "tanerlacin@hotmail.com.tr;",
            "22204113": "arcelik4575@outlook.com;",
            "22225004": "syuksel8@hotmail.com.tr;",
            "22258001": "yilmaztic.arc@gmail.com;",
            "22204117": "saim@eminsateknoloji.com;",
            "22258102": "i.eroglu58@hotmail.com;",
            "22225599": "syuksel8@hotmail.com.tr;",
            "22276005": "arcelik_76@hotmail.com;",
            "22204119": "cesimturan202@gmail.com;",
            "22225017": "sahin-tn@hotmail.com;",
            "22225125": "arceliktekmanbayi@gmail.com;",
            "22276102": "cekim.pazarlama@hotmail.com;",
            "22204114": "gkhnyuce_arc@hotmail.com;",
            "22275102": "polathasan755@gmail.com;",
            "22224105": "e_gursoy2005@hotmail.com;",
            "22225119": "onur.onur.81@hotmail.com;",
            "22258103": "serhatkangal@hotmail.com;",
            "22224106": "kusogluarcelik@gmail.com;",
            "22229105": "mertmelih61@hotmail.com;",
            "22161131": "macka.arcelik@hotmail.com;",
            "22155121": "arpalarticaret@gmail.com;",
            "22160005": "serdar_ucar060@hotmail.com;",
            "22318002": "hasaltin18@hotmail.com;",
            "22105004": "info@ozkokbeyazesya.com.tr;",
            "22155507": "iletisim@kucukerler.com.tr;",
            "22318006": "edipsarikaya@hotmail.com;",
            "22319106": "ozdoganlararcelik@gmail.com;",
            "22152120": "tahatuna@hotmail.com;",
            "22108112": "melihtemur84@hotmail.com;",
            "22161130": "arcelikergan@hotmail.com;",
            "22152117": "hilal_ticaret_golkoy@hotmail.com;",
            "22153003": "veyavuz34@gmail.com;",
            "22160118": "erhansenel_arc@hotmail.com;",
            "22155132": "ersinyildiz_telekom@hotmail.com;",
            "22161005": "recep_efendi@hotmail.com;",
            "22161006": "arplazaforum@hotmail.com;",
            "22155133": "ugurlu.arcelik@hotmail.com;",
            "22155111": "ensar.2@hotmail.com;",
            "22161508": "arplazamerkez@hotmail.com;",
            "22155004": "arcahmetyalcin@hotmail.com;",
            "22128008": "sertacgunes@gmail.com;",
            "22161507": "arplazamerkez@hotmail.com;",
            "22319118": "ocakli_arcelik@hotmail.com;",
            "22161102": "olgunkasap@hotmail.com;",
            "22155019": "egemenbyz@hotmail.com;",
            "22152009": "umit.nasuhbeyoglu@nasuhbeyoglu.com.tr;",
            "22155533": "ugurlu.arcelik@hotmail.com;",
            "22155107": "metin.yilmaz.1960@hotmail.com;",
            "22319117": "sword_19_@hotmail.com;",
            "22155128": "dundar155@hotmail.com;",
            "22128121": "info@sarigoller.com;",
            "22153116": "tevfik_2979@hotmail.com;",
            "22108111": "deryaticaret08@hotmail.com;",
            "22319518": "a_istanbulluoglu@hotmail.com;",
            "22128560": "serkantokul@tokullarmobilya.com;",
            "22155123": "senerlerarcelik@hotmail.com;",
            "22318005": "havanltd@hotmail.com;",
            "22161007": "mustafa_kocin@hotmail.com;",
            "22152114": "gunermobilya52@gmail.com;",
            "22155021": "irmaklarltd@gmail.com;",
            "22152010": "info@sarigoller.com;",
            "22161117": "i.hakkisolakli@hotmail.com;",
            "22161126": "huseyinkurukiz61@hotmail.com;",
            "22128502": "huseyinkurukiz61@hotmail.com;",
            "22160117": "sargintic@msn.com;",
            "22161122": "huzurtic61@gmail.com;",
            "22160111": "arcelik@hotmail.com;",
            "22319519": "ihsan_364@hotmail.com;",
            "22155114": "aekmekci@biri.com.tr;",
            "22160113": "ali_alhun@hotmail.com;",
            "22153002": "musatarakci.arcelik053@gmail.com;",
            "22128112": "hakandede@gmail.com;",
            "22155125": "ateslerticaret@hotmail.com;",
            "22155504": "ensar.2@hotmail.com;",
            "22108003": "mehmetonen_08@hotmail.com;",
            "22319004": "ihsan_364@hotmail.com;",
            "22128123": "fevzetindmr@outlook.com;",
            "22105111": "arceliksuluova@gmail.com;",
            "22160101": "cihatarcelik@mynet.com;",
            "22108110": "erserticaret@hotmail.com;",
            "22319007": "a_istanbulluoglu@hotmail.com;",
            "22318103": "dosteller@outlook.com.tr;",
            "22153117": "pazar.arcelikbayi53@hotmail.com;",
            "22160501": "slmsrgn@hotmail.com;",
            "22128660": "harunyurtsever71@hotmail.com;",
            "22155127": "iletisim@kucukerler.com.tr;",
            "22152101": "aagursoylu@hotmail.com;",
            "22153001": "ibrahimguveli@hotmail.com;",
            "22153115": "cayelidoviz@hotmail.com;",
            "22152007": "bulus_arcelik@hotmail.com;",
            "22152011": "arcelikaltas@gmail.com;",
            "22161511": "arplazamerkez@hotmail.com;",
            "22161125": "vakfikebirarcelik61@hotmail.com;",
            "22160108": "emrah180@mynet.com;",
            "22105114": "hamdullahhuriye@hotmail.com;",
            "22152104": "kkaramustafa@hotmail.com;",
            "22155504": "ensar.2@hotmail.com;",
            "22108102": "mustafaaltunsoy@hotmail.com;",
            "22155001": "rustuaraboglu@gmail.com;",
            "22155118": "akcaarcelik@hotmail.com;",
            "22319013": "arslaner20@hotmail.com;",
            "22161617": "metinsolakli@gmail.com;",
            "22128116": "alirizaaydin22128116@gmail.com;",
            "22155018": "fatihtemiz5555@hotmail.com;",
            "22128006": "ataunarcelik@gmail.com;",
            "22319113": "yucelkucukali@hotmail.com;",
            "22318108": "satilmis-alt@hotmail.com;",
            "22155102": "dursun.aygul@hotmail.com;",
            "22161513": "mustafa_kocin@hotmail.com;",
            "22161009": "necatitokul@tokuloglu.com;",
            "22155009": "ciftlik_oztotuklar@outlook.com;",
            "22155523": "senerlerarcelik@hotmail.com;",
            "22161121": "serkantokul@tokullarmobilya.com;",
            "22160107": "fatihgokay@hotmail.com;",
            "22160006": "tokatyilmazlar@gmail.com;",
            "22152124": "gumusogluav@gmail.com;",
            "22105115": "bozkurtlararcelik@gmail.com;",
            "22128503": "harunyurtsever71@hotmail.com;",
            "22160001": "armaganoguzhan@hotmail.com;",
            "22319112": "korogluticaret@hotmail.com;",
            "22160114": "mustafaguler2512@hotmail.com;",
            "22153102": "sarikaya.arcelik@hotmail.com;",
            "22128122": "m_kahraman79@hotmail.com;",
            "22128106": "nakipogluarcelik@gmail.com;",
            "22155130": "tesnimbuyuk@gmail.com;",
            "22152118": "gozdekollsti2@gmail.com;"
        };

        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';

            const dbRef = database.ref();
            dbRef.get().then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const questionsData = data.fideQuestionsData;
                    
                    // Sadece Melih Kotbaş'a ait e-posta verisini çekiyoruz
                    const emailData = data.bayiEmailData ? data.bayiEmailData.MelihKotbas : null;

                    if (questionsData) {
                        allQuestionsData = questionsData;
                        renderForm(allQuestionsData);
                    } else {
                        console.log("Bulutta soru verisi bulunamadı.");
                    }
                    
                    if (emailData) {
                        bayiEmailMappings = emailData;
                        console.log("Bayi e-posta bilgileri buluttan başarıyla yüklendi.");
                    } else {
                        console.log("Bulutta bayi e-posta verisi bulunamadı. Yerel veri kullanılacak.");
                        bayiEmailMappings = melihsBayiData; // Bulutta yoksa yereldekini kullan
                    }

                } else {
                    console.log("Firebase'de veri bulunamadı.");
                }
            }).catch((error) => {
                console.error("Firebase'den veri okunurken hata oluştu:", error);
                alert("HATA: Veriler sunucudan alınamadı. Lütfen internet bağlantınızı kontrol edin.");
            }).finally(() => {
                loadingOverlay.style.display = 'none';
                updateFormInteractivity(true);
            });

            setupEventListeners();
            setupModalListeners();
        });
        
        // Diğer fonksiyonlar buraya eklenecek...
        function renderForm(data) {
            const formContent = document.getElementById('form-content');
            formContent.innerHTML = '';
            for (const barId in data) {
                const barData = data[barId];
                const barElement = createBarElement(barId, barData.name);
                const itemList = barElement.querySelector('.item-list');
                
                barData.items.forEach(item => {
                    const itemElement = createItemElement(item.id, item.text, item.bayiKodu, item.unvan);
                    itemList.appendChild(itemElement);
                });
                formContent.appendChild(barElement);
            }
        }

        function createBarElement(barId, barName) {
            const barDiv = document.createElement('div');
            barDiv.className = 'card bar';
            barDiv.dataset.barId = barId;
            barDiv.innerHTML = `
                <div class="bar-header">
                    <h3 class="bar-title">${barName}</h3>
                    <div class="bar-controls">
                        <button class="delete-bar btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <ul class="item-list"></ul>
            `;
            return barDiv;
        }

        function createItemElement(itemId, itemText, bayiKodu, unvan) {
            const li = document.createElement('li');
            li.className = 'item';
            li.dataset.itemId = itemId;
            li.innerHTML = `
                <div class="item-content">
                    <span class="item-text">${itemText}</span>
                    <div class="item-details">
                        <span class="bayi-kodu">Bayi Kodu: ${bayiKodu}</span>
                        <span class="unvan">Unvan: ${unvan}</span>
                    </div>
                </div>
                <div class="item-controls">
                    <button class="status-btn btn-success btn-sm"><i class="fas fa-check"></i> Tamamlandı</button>
                    <button class="delete-item-btn btn-danger btn-sm"><i class="fas fa-times"></i></button>
                </div>
            `;
            return li;
        }

        function setupEventListeners() {
            document.getElementById('toggle-manager-btn').addEventListener('click', () => {
                const manager = document.getElementById('question-manager');
                manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
            });
            
             document.getElementById('save-to-cloud-btn').addEventListener('click', saveQuestionsToCloud);
             
            // E-posta yükleme butonu için event listener
            document.getElementById('upload-emails-btn').addEventListener('click', saveBayiEmailsToCloud);

            // E-posta taslağı oluşturma butonu için event listener
            document.getElementById('email-draft-btn').addEventListener('click', generateEmailDraft);
        }

        function setupModalListeners() {
            const modal = document.getElementById('email-modal');
            const closeBtn = document.querySelector('.close-button');
            const copyBtn = document.getElementById('copy-email-btn');

            closeBtn.onclick = () => { modal.style.display = "none"; }
            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            copyBtn.addEventListener('click', () => {
                const emailBody = document.getElementById('email-output');
                const range = document.createRange();
                range.selectNodeContents(emailBody);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                try {
                    document.execCommand('copy');
                    alert('E-posta içeriği panoya kopyalandı!');
                } catch (err) {
                    alert('Kopyalama başarısız oldu.');
                }
                selection.removeAllRanges();
            });
        }
        
        function generateEmailDraft() {
            const completedItems = document.querySelectorAll('.item.completed');
            if (completedItems.length === 0) {
                alert("E-posta taslağı oluşturmak için önce en az bir maddeyi 'Tamamlandı' olarak işaretlemelisiniz.");
                return;
            }

            let emailBody = '<ul>';
            completedItems.forEach(item => {
                const bayiKodu = item.querySelector('.bayi-kodu')?.textContent.trim().replace('Bayi Kodu: ', '') || '';
                const text = item.querySelector('.item-text').textContent.trim();
                
                const email = bayiEmailMappings[bayiKodu];
                const emailLink = email ? ` <a href="mailto:${email.replace(';', '')}" style="color: #007B9A; text-decoration:none; font-weight: bold;">(${email.replace(';', '')})</a>` : '';

                emailBody += `<li>${text}${emailLink}</li>`;
            });
            emailBody += '</ul>';

            document.getElementById('email-output').innerHTML = emailBody;
            document.getElementById('email-modal').style.display = 'block';
        }


        function saveBayiEmailsToCloud() {
            if (!confirm("Bu işlem, size ait bayi e-posta listesini buluta kaydedecektir. Mevcut liste üzerine yazılacaktır. Devam etmek istiyor musunuz?")) {
                return;
            }

            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';

            const emailsRef = database.ref('bayiEmailData/MelihKotbas'); // Veriyi size özel bir alana kaydediyoruz
            emailsRef.set(melihsBayiData)
                .then(() => {
                    alert("Bayi e-posta adresleri başarıyla buluta kaydedildi.");
                    bayiEmailMappings = melihsBayiData; // Yerel veriyi de güncelle
                })
                .catch(error => {
                    console.error("E-postalar buluta kaydedilirken hata oluştu:", error);
                    alert("HATA: E-postalar buluta kaydedilemedi. Lütfen internet bağlantınızı kontrol edin.");
                })
                .finally(() => {
                    loadingOverlay.style.display = 'none';
                });
        }

        async function saveQuestionsToCloud() {
            const bars = document.querySelectorAll('.bar');
            let finalJsonData = {};

            bars.forEach(bar => {
                const barId = bar.dataset.barId;
                const barName = bar.querySelector('.bar-title').textContent;
                finalJsonData[barId] = { name: barName, items: [] };

                const items = bar.querySelectorAll('.item');
                items.forEach(item => {
                    finalJsonData[barId].items.push({
                        id: item.dataset.itemId,
                        text: item.querySelector('.item-text').textContent,
                        bayiKodu: item.querySelector('.bayi-kodu').textContent.replace('Bayi Kodu: ', ''),
                        unvan: item.querySelector('.unvan').textContent.replace('Unvan: ', '')
                    });
                });
            });

            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';

            try {
                const questionsRef = database.ref('fideQuestionsData');
                await questionsRef.set(finalJsonData);
                alert("Değişiklikler başarıyla buluta kaydedildi. Sayfa yenileniyor...");
                window.location.reload();
            } catch (error) {
                console.error("Sorular buluta kaydedilirken hata oluştu:", error);
                alert("HATA: Değişiklikler buluta kaydedilemedi. Lütfen internet bağlantınızı kontrol edin ve tekrar deneyin.");
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function updateFormInteractivity(enable) {
            const formContent = document.getElementById('form-content');
            if (!formContent) return;

            const buttons = formContent.querySelectorAll('.status-btn, .delete-item-btn');
            buttons.forEach(btn => { btn.disabled = !enable; });
        }
        
        // Form içeriğindeki butonlar için olay dinleyicisi (event delegation)
        document.getElementById('form-content').addEventListener('click', function(e) {
            if (e.target.closest('.status-btn')) {
                const button = e.target.closest('.status-btn');
                const item = button.closest('.item');
                item.classList.toggle('completed');
                
                if (item.classList.contains('completed')) {
                    button.innerHTML = '<i class="fas fa-undo"></i> Geri Al';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-warning');
                } else {
                    button.innerHTML = '<i class="fas fa-check"></i> Tamamlandı';
                    button.classList.remove('btn-warning');
                    button.classList.add('btn-success');
                }
            }
            // Diğer butonlar için de benzer mantık eklenebilir.
        });

    </script>
</body>
</html>