<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Denetim Formu (Bulut Entegreli)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #008CBA; --primary-dark: #007B9A; --secondary: #64748b; --success: #16a34a; --success-light: #dcfce7; --warning: #eab308; --danger: #dc2626; --light: #f8fafc; --dark: #1e293b; --gray: #94a3b8; --border: #e2e8f0; --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); --transition: all 0.3s ease;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 14px; line-height: 1.6; color: var(--dark); background-color: #f1f5f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: var(--card-shadow); padding: 24px; margin-bottom: 24px; transition: var(--transition); }
        h2 { font-size: 20px; color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; }
        button, .btn-like-label { cursor: pointer; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; }
        button:disabled { background-color: var(--gray); cursor: not-allowed; opacity: 0.7; }
        button i, .btn-like-label i { margin-right: 8px; }
        .btn-primary { background-color: var(--primary); color: white; } .btn-success { background-color: var(--success); color: white; } .btn-danger { background-color: var(--danger); color: white; } .btn-warning { background-color: var(--warning); color: var(--dark); } .btn-sm { padding: 6px 12px; font-size: 12px; }
        .action-button { width: 100%; padding: 12px; font-size: 15px; margin: 10px 0 30px; border-radius: 10px; background-color: var(--primary); color: white; }
        .fide-item { margin-bottom: 28px; padding: 20px; border-radius: 12px; background-color: white; box-shadow: var(--card-shadow); transition: var(--transition); }
        .fide-item.question-removed { opacity: 0.6; background-color: #fafafa; }
        .fide-title-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px;}
        .fide-title-container p { font-weight: 600; margin: 0; flex-grow: 1; font-size: 16px; color: var(--dark); }
        .fide-title-container.question-completed p { color: var(--success); text-decoration: line-through; }
        .fide-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-right: 8px; background-color: var(--primary); color: white; }
        .static-item, .dynamic-input-item { display: flex; align-items: center; margin-bottom: 12px; padding: 12px; background-color: var(--light); border-radius: 8px; transition: all 0.3s ease; overflow: hidden; }
        .static-item .content { flex-grow: 1; transition: all 0.3s ease; }
        .dynamic-input-item input[type="text"] { flex-grow: 1; border: 1px solid var(--border); padding: 10px; border-radius: 6px; transition: all 0.3s ease;}
        .dynamic-input-item input[type="text"].completed { text-decoration: line-through; color: var(--success); background-color: var(--success-light); }
        .delete-bar { flex-shrink: 0; width: 32px; border-radius: 0 8px 8px 0; cursor: pointer; align-self: stretch; display: flex; align-items: center; justify-content: center; margin: -12px -12px -12px 15px; padding: 12px 0; }
        .product-adder { display: flex; gap: 10px; align-items: center; margin: 15px 0; }
        .product-adder select { flex-grow: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
        .product-adder input[type="number"] { width: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
        .selected-product-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background-color: var(--light); border-radius: 8px; margin-bottom: 8px; }
        textarea { width: 100%; padding: 16px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; margin-bottom: 16px; }
        .file-input-wrapper { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 1rem; }
        .file-input-wrapper input[type="file"] { display: none; }
        .file-input-label { background-color: var(--primary); color: white; padding: 6px 12px; font-size: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; transition: var(--transition); }
        #file-name, #fide-file-name { font-style: italic; color: var(--dark); }
        #store-selection-area { display: none; margin-top: 20px; }
        #store-search-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 12px; font-size: 16px; }
        #store-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 5px; }
        .store-item { padding: 10px; cursor: pointer; border-radius: 4px; margin-bottom: 4px; }
        .store-item:hover { background-color: #f1f5f9; }
        .store-item.selected { background-color: var(--success); color: white; font-weight: bold; }
        #clear-excel-btn, #clear-fide-excel-btn { display: none; }
        .top-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        #status-indicator { font-size: 12px; font-weight: 600; padding: 6px 12px; border-radius: 8px; transition: var(--transition); }
        #status-indicator.connecting { color: var(--dark); background-color: var(--warning); }
        #status-indicator.synced { color: white; background-color: var(--success); }
        #status-indicator.error { color: white; background-color: var(--danger); }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-controls">
            <div id="status-indicator" class="connecting"><i class="fas fa-sync-alt fa-spin"></i> Buluta Bağlanılıyor...</div>
            <button id="toggle-manager-btn" class="btn-warning btn-sm"><i class="fas fa-edit"></i> Soru Yöneticisi</button>
        </div>
        
        <div class="card" id="question-manager" style="display: none;"><h2><i class="fas fa-cogs"></i> FiDe Soru Yöneticisi</h2><p style="font-size: 12px; color: var(--secondary); margin-top: -15px; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Buradan FİDE sorularını düzenleyin. <b>Kaydet</b> tuşuna bastığınızda size <b>"fide_soru_listesi.json"</b> adında bir dosya indirilecek. Bu dosyayı mevcut olanla değiştirin ve sayfayı yenileyin.</p><div class="manager-actions"><button onclick="saveQuestions()" class="btn-success"><i class="fas fa-save"></i> Değişiklikleri Kaydet ve Dosyayı İndir</button><button onclick="addNewQuestionUI()" class="btn-primary"><i class="fas fa-plus"></i> Yeni Soru Ekle</button></div><div id="manager-list"></div></div>
        <div class="card" id="dide-upload-card"><h2><i class="fas fa-chart-line"></i> Puan Entegrasyonu ve Veri Yönetimi</h2><div id="excel-expiry-warning" style="display: none; color: #b91c1c; background-color: #fee2e2; border: 1px solid #f87171; border-radius: 8px; padding: 15px; margin-bottom: 20px;"><p><i class="fas fa-exclamation-triangle"></i> Veri Uyarısı</p><span>Aşağıdaki dosyalar 30 günden eski olduğu için hafızadan silindi. Lütfen güncel versiyonlarını tekrar yükleyin:</span><ul id="expired-files-list"></ul></div><p style="font-size: 12px; color: var(--secondary); margin-top: -15px; margin-bottom: 15px;"><i class="fas fa-info-circle"></i> Excel verileri tarayıcı hafızasında saklanır. Raporlarınız ise artık güvenli bir şekilde bulutta saklanmaktadır.</p><div><p><b>1. Adım: DiDe Puan Excel Dosyasını Yükleyin</b></p><div class="file-input-wrapper"><label for="excel-file-input" class="file-input-label btn-sm" title="Bayi DiDe puanlarını içeren Excel dosyasını seçmek için tıklayın."><i class="fas fa-file-excel"></i> DiDe Excel'i Seç</label><input type="file" id="excel-file-input" accept=".xlsx, .xls" style="display: none;"><span id="file-name">Henüz dosya seçilmedi.</span></div></div><div style="margin-top: 20px;"><p><b>2. Adım: FiDe Puan Excel Dosyasını Yükleyin</b></p><div class="file-input-wrapper"><label for="fide-excel-file-input" class="file-input-label btn-sm" title="Bayi FiDe puanlarını içeren Excel dosyasını seçmek için tıklayın."><i class="fas fa-file-excel"></i> FiDe Excel'i Seç</label><input type="file" id="fide-excel-file-input" accept=".xlsx, .xls" style="display: none;"><span id="fide-file-name">Henüz dosya seçilmedi.</span></div></div><div style="margin-top: 20px;"><p><b>3. Adım: Veri Temizleme</b></p><div class="file-input-wrapper"><button id="clear-all-cloud-data-btn" class="btn-danger btn-sm" title="UYARI: Buluttaki tüm bayi raporlarını kalıcı olarak siler."><i class="fas fa-eraser"></i> Buluttaki Tüm Raporları Sil</button><button id="clear-excel-btn" class="btn-danger btn-sm" title="Yüklenmiş olan DiDe Excel verisini tarayıcı hafızasından temizler."><i class="fas fa-trash-alt"></i> DiDe Excell'i Sil</button><button id="clear-fide-excel-btn" class="btn-danger btn-sm" title="Yüklenmiş olan FiDe Excel verisini tarayıcı hafızasından temizler."><i class="fas fa-trash-alt"></i> FiDe Excell'i Sil</button></div></div><div id="store-selection-area"><hr style="margin: 20px 0;"><p><b>4. Adım: Denetlenecek Bayiyi Arayın ve Seçin</b></p><button id="new-report-btn" class="btn-warning btn-sm" style="margin-bottom: 10px; width: 100%;" title="Mevcut formu boşaltır ve temiz bir rapor sayfası açar."><i class="fas fa-file"></i> Yeni Rapor / Formu Temizle</button><input type="text" id="store-search-input" placeholder="Bayi adı veya kodu ile aramaya başlayın..."><div id="store-list"></div></div></div>
        <div class="card" id="initialization-error" style="display: none;"><h2><i class="fas fa-exclamation-triangle"></i> Başlatma Hatası</h2><p><b><code>fide_soru_listesi.json</code></b> dosyası bulunamadı veya okunamadı. Lütfen bu HTML dosyasıyla aynı klasörde olduğundan emin olun. Form, geçici olarak varsayılan sorularla yüklendi.</p></div>
        <div id="form-content"></div>
        <button class="action-button" onclick="generateEmail()" title="Formdaki tüm verileri kullanarak nihai e-posta taslağını oluşturur ve raporu kaydeder."><i class="fas fa-envelope"></i> E-POSTA TASLAĞI OLUŞTUR</button>
        <div class="card" id="save-section" style="display: none;"><h2><i class="fas fa-code"></i> MANUEL YEDEKLEME İÇİN RAPOR KODU</h2><p>Raporunuz artık buluta otomatik kaydediliyor. Bu kod, çok istenirse manuel olarak başka bir yere yedeklemek veya başka birine göndermek için oluşturulmuştur.</p><textarea id="save-code-area" readonly></textarea><button class="btn-success" id="download-report-btn" onclick="downloadReportCode()" style="margin-top: 10px;" title="Oluşturulan raporun manuel yedek kodunu bir metin dosyası olarak indirir."><i class="fas fa-download"></i> Rapor Kodunu İndir (.txt)</button></div>
    </div>

    <script>
    // Sizin tarafınızdan sağlanan ve güncellenen Firebase yapılandırma bilgileri
    const firebaseConfig = {
      apiKey: "AIzaSyCvUBeaqFSlbLsDd0zkwEoEj0sXet1wVq8",
      authDomain: "fide-denetim-sistemi.firebaseapp.com",
      databaseURL: "https://fide-denetim-sistemi-default-rtdb.firebaseio.com/",
      projectId: "fide-denetim-sistemi",
      storageBucket: "fide-denetim-sistemi.firebasestorage.app",
      messagingSenderId: "733807364443",
      appId: "1:733807364443:web:2dd374967cf110cb87f27e"
    };

    // Firebase'i Başlatma
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    let currentUser = null;
    let allReports = {}; 

    // GLOBAL DEĞİŞKENLER
    let dideData = [], fideData = [], uniqueStores = [], selectedStore = null, fideQuestions = [], popCodes = [], expiredCodes = [], productList = [], expiredExcelFiles = [];
    const fallbackFideQuestions = [{ id: 0, type: 'standard', title: "HATA: fide_soru_listesi.json dosyası yüklenemedi." }];
    const monthNames = ["", "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
    
    // --- YARDIMCI FONKSİYONLAR ---

    function setStatus(message, type) { 
        const indicator = document.getElementById('status-indicator'); 
        if(indicator) { 
            indicator.className = type; 
            indicator.innerHTML = message; 
        } 
    }

    // --- FIREBASE VERİ YÖNETİMİ ---

    function getFormDataForSaving() { 
        let reportData = { selectedStore: selectedStore, questions_status: {} }; 
        fideQuestions.forEach(q => { 
            const itemDiv = document.getElementById(`fide-item-${q.id}`); 
            if(!itemDiv) return; 
            const isRemoved = itemDiv.classList.contains('question-removed'); 
            const titleContainer = itemDiv.querySelector('.fide-title-container'); 
            const isCompleted = titleContainer ? titleContainer.classList.contains('question-completed') : false; 
            const questionData = { removed: isRemoved, completed: isCompleted, dynamicInputs: [], selectedProducts: [], selectedPops: [] }; 
            
            if (q.type === 'standard') { 
                const container = document.getElementById(`sub-items-container-fide${q.id}`); 
                if(container) { 
                    questionData.dynamicInputs = Array.from(container.querySelectorAll('.dynamic-input-item:not(.is-deleting)')).map(node => ({ text: node.querySelector('input').value.trim(), completed: node.querySelector('input').classList.contains('completed') })).filter(item => item.text); 
                } 
            } else if (q.type === 'product_list') { 
                questionData.selectedProducts = Array.from(document.querySelectorAll('#selected-products-list .selected-product-item')).map(item => ({ id: item.dataset.id, qty: item.dataset.qty })); 
                const pleksiContainer = document.getElementById('sub-items-container-fide15_pleksi'); 
                if(pleksiContainer) { 
                    questionData.dynamicInputs = Array.from(pleksiContainer.querySelectorAll('.dynamic-input-item:not(.is-deleting)')).map(node => ({ text: node.querySelector('input').value.trim(), completed: node.querySelector('input').classList.contains('completed') })).filter(item => item.text); 
                } 
            } else if (q.type === 'pop_system') { 
                questionData.selectedPops = Array.from(document.querySelectorAll('.pop-checkbox:checked')).map(cb => cb.value); 
            } 
            reportData.questions_status[q.id] = questionData; 
        }); 
        return reportData; 
    }
    
    function saveFormState() { 
        if (!document.getElementById('form-content').innerHTML || !selectedStore) return; 
        setStatus('<i class="fas fa-sync-alt fa-spin"></i> Kaydediliyor...', 'connecting'); 
        const reportData = getFormDataForSaving(); 
        const storeKey = `store_${selectedStore.bayiKodu}`; 
        allReports[storeKey] = { timestamp: firebase.database.ServerValue.TIMESTAMP, data: reportData }; 
        saveDataToFirebase(allReports); 
    }
    
    async function saveDataToFirebase(data) { 
        if (!currentUser) { 
            setStatus('<i class="fas fa-exclamation-triangle"></i> Bağlantı Yok', 'error'); 
            return; 
        } 
        try { 
            await db.ref(`users/${currentUser.uid}/allFideReports`).set(data); 
            setStatus('<i class="fas fa-check-circle"></i> Buluta Kaydedildi', 'synced'); 
        } catch (error) { 
            console.error("Firebase'e yazma hatası:", error); 
            setStatus('<i class="fas fa-exclamation-triangle"></i> Kayıt Hatası!', 'error'); 
            alert("Veriler buluta kaydedilemedi. İnternet bağlantınızı kontrol edin."); 
        } 
    }
    
    function loadDataFromFirebase() { 
        setStatus('<i class="fas fa-cloud-download-alt"></i> Veriler Yükleniyor...', 'connecting'); 
        db.ref(`users/${currentUser.uid}/allFideReports`).get().then((snapshot) => { 
            if (snapshot.exists()) { 
                allReports = snapshot.val(); 
            } else { 
                allReports = {}; 
            } 
            setStatus('<i class="fas fa-check-circle"></i> Veriler Yüklendi', 'synced'); 
            restoreLastSession(); 
        }).catch((error) => { 
            console.error("Firebase'den okuma hatası:", error); 
            setStatus('<i class="fas fa-exclamation-triangle"></i> Yükleme Hatası!', 'error'); 
            alert("Buluttan veriler alınamadı. İnternet bağlantınızı kontrol edin."); 
        }); 
    }
    
    function loadReportForStore(bayiKodu) { 
        const storeKey = `store_${bayiKodu}`; 
        if (allReports && allReports[storeKey]) { 
            loadReport(allReports[storeKey].data); 
        } else { 
            resetForm(); 
        } 
    }

    function loadReport(reportData) { 
        resetForm(); 
        if (reportData.selectedStore) { 
            selectedStore = reportData.selectedStore; 
            localStorage.setItem('lastSelectedStoreCode', selectedStore.bayiKodu); 
            const searchInput = document.getElementById('store-search-input'); 
            let shortBayiAdi = selectedStore.bayiAdi.length > 20 ? selectedStore.bayiAdi.substring(0, 20) + '...' : selectedStore.bayiAdi; 
            searchInput.value = `${selectedStore.bayiKodu} - ${shortBayiAdi}`; 
            document.getElementById('store-list').style.display = 'none'; 
        } 
        for (const qId in reportData.questions_status) { 
            const data = reportData.questions_status[qId]; 
            const questionItem = document.getElementById(`fide-item-${qId}`); 
            if (!questionItem) continue; 
            const completeButton = questionItem.querySelector('.fide-actions .status-btn'); 
            const removeButton = questionItem.querySelector('.fide-actions .remove-btn'); 
            if (data.removed && removeButton) toggleQuestionRemoved(removeButton, qId); 
            else if (data.completed && completeButton) toggleQuestionCompleted(completeButton, qId); 
            if (data.dynamicInputs) data.dynamicInputs.forEach(input => addDynamicInput(qId === '15' ? 'fide15_pleksi' : `fide${qId}`, input.text, input.completed)); 
            if (data.selectedProducts) data.selectedProducts.forEach(prod => addProductToList(prod.id, prod.qty)); 
            if (data.selectedPops) { data.selectedPops.forEach(popCode => { const cb = document.querySelector(`.pop-checkbox[value="${popCode}"]`); if(cb) cb.checked = true; }); } 
        } 
    }
    
    function restoreLastSession() { 
        const lastStoreCode = localStorage.getItem('lastSelectedStoreCode'); 
        if (lastStoreCode && uniqueStores.length > 0) { 
            const storeToRestore = uniqueStores.find(s => String(s.bayiKodu) === String(lastStoreCode)); 
            if (storeToRestore) { 
                selectedStore = storeToRestore; 
                const searchInput = document.getElementById('store-search-input'); 
                let shortBayiAdi = storeToRestore.bayiAdi.length > 20 ? storeToRestore.bayiAdi.substring(0, 20) + '...' : storeToRestore.bayiAdi; 
                searchInput.value = `${storeToRestore.bayiKodu} - ${shortBayiAdi}`; 
                document.getElementById('store-list').style.display = 'none'; 
                loadReportForStore(storeToRestore.bayiKodu); 
            } 
        } 
    }

    // --- FORM İŞLEVSELLİK FONKSİYONLARI ---
    
    function getUnitForProduct(productName) { const upperCaseName = productName.toUpperCase(); if (upperCaseName.includes('TSHIRT') || upperCaseName.includes('HIRKA')) { return 'Adet'; } return 'Paket'; }
    
    function resetForm() { document.getElementById('form-content').innerHTML = ''; buildForm(); }
    
    function buildForm() { const formContainer = document.getElementById('form-content'); formContainer.innerHTML = ''; let html = ''; fideQuestions.forEach(q => { let questionActionsHTML = ''; let questionContentHTML = ''; if (q.type === 'standard') { questionActionsHTML = `<div class="fide-actions"><button class="add-item-btn btn-sm" onclick="addDynamicInput('fide${q.id}')"><i class="fas fa-plus"></i> Yeni Eksik Ekle</button><button class="status-btn btn-sm" onclick="toggleQuestionCompleted(this, ${q.id})"><i class="fas fa-check"></i> Tamamlandı</button><button class="remove-btn btn-danger btn-sm" onclick="toggleQuestionRemoved(this, ${q.id})"><i class="fas fa-times-circle"></i> Çıkar</button></div>`; let staticItemsHTML = (q.staticItems || []).map(item => `<div class="static-item"><div class="content">${item}</div><button class="delete-bar btn-danger" onclick="initiateDeleteItem(this)"><i class="fas fa-trash"></i></button></div>`).join(''); questionContentHTML = `<div class="input-area"><div id="sub-items-container-fide${q.id}">${staticItemsHTML}</div></div>`; } else if (q.type === 'product_list') { questionActionsHTML = `<div class="fide-actions"><button class="add-item-btn btn-sm" onclick="addDynamicInput('fide15_pleksi')"><i class="fas fa-plus"></i> Yeni Ekle</button><button class="status-btn btn-sm" onclick="toggleQuestionCompleted(this, ${q.id})"><i class="fas fa-check"></i> Tamamlandı</button><button class="remove-btn btn-danger btn-sm" onclick="toggleQuestionRemoved(this, ${q.id})"><i class="fas fa-times-circle"></i> Çıkar</button></div>`; let productOptions = ''; let currentOptgroup = false; productList.forEach(p => { if (p.type === 'header') { if (currentOptgroup) productOptions += `</optgroup>`; productOptions += `<optgroup label="${p.name}">`; currentOptgroup = true; } else { productOptions += `<option value="${p.id}">${p.code} - ${p.name}</option>`; } }); if (currentOptgroup) productOptions += `</optgroup>`; questionContentHTML = `<div class="input-area"><b><i>Sipariş verilmesi gerekenler:</i></b><div class="product-adder"><select id="product-selector"><option value="">-- Malzeme Seçin --</option>${productOptions}</select><input type="number" id="product-qty" placeholder="Adet" min="1" value="1"><button class="btn-success btn-sm" onclick="addProductToList()"><i class="fas fa-plus"></i> Ekle</button></div><div id="selected-products-list"></div><hr><b><i>Pleksiyle ilgili notlar:</i></b><div id="sub-items-container-fide15_pleksi"></div></div>`; } else if (q.type === 'pop_system') { questionActionsHTML = `...`; questionContentHTML = `...`; } html += `<div class="fide-item" id="fide-item-${q.id}"><div class="fide-title-container"><p><span class="badge">FiDe ${q.id}</span> ${q.title}</p></div>${questionContentHTML}${questionActionsHTML}</div>`; }); formContainer.innerHTML = html; }
    
    function initiateDeleteItem(buttonEl) { const itemEl = buttonEl.parentElement; if (itemEl.classList.contains('is-deleting')) { clearTimeout(itemEl.dataset.deleteTimer); itemEl.removeAttribute('data-delete-timer'); itemEl.classList.remove('is-deleting'); buttonEl.querySelector('i').className = 'fas fa-trash'; buttonEl.classList.remove('btn-warning'); buttonEl.classList.add('btn-danger'); } else { itemEl.classList.add('is-deleting'); buttonEl.querySelector('i').className = 'fas fa-undo'; buttonEl.classList.remove('btn-danger'); buttonEl.classList.add('btn-warning'); const timerId = setTimeout(() => { itemEl.remove(); saveFormState(); }, 4000); itemEl.dataset.deleteTimer = timerId; } saveFormState(); }
    
    function addProductToList(productId, quantity) { const select = document.getElementById('product-selector'); const qtyInput = document.getElementById('product-qty'); const selectedProductId = productId || select.value; const selectedQty = quantity || qtyInput.value; if (!selectedProductId || !selectedQty || selectedQty < 1) return alert('Lütfen malzeme ve geçerli bir miktar girin.'); const product = productList.find(p => p.id === selectedProductId); const listContainer = document.getElementById('selected-products-list'); if (document.querySelector(`.selected-product-item[data-id="${product.id}"]`)) return alert('Bu ürün zaten listede.'); const unit = getUnitForProduct(product.name); const newItem = document.createElement('div'); newItem.className = 'selected-product-item'; newItem.dataset.id = product.id; newItem.dataset.qty = selectedQty; newItem.innerHTML = `<span>${product.code} ${product.name} - <b>${selectedQty} ${unit}</b></span><button class="delete-item-btn btn-sm" title="Bu malzemeyi sil" onclick="this.parentElement.remove(); saveFormState();"><i class="fas fa-trash"></i></button>`; listContainer.appendChild(newItem); if (!productId) { select.value = ''; qtyInput.value = '1'; } saveFormState(); }
    
    function toggleCompleted(button) { const input = button.parentElement.querySelector('input[type="text"]'); const isCompleted = input.classList.toggle('completed'); input.readOnly = isCompleted; button.innerHTML = isCompleted ? '<i class="fas fa-undo"></i> Geri Al' : '<i class="fas fa-check"></i> Tamamlandı'; button.classList.toggle('undo', isCompleted); saveFormState(); }
    
    function toggleQuestionCompleted(button, id) { const itemDiv = document.getElementById(`fide-item-${id}`); const titleContainer = itemDiv.querySelector('.fide-title-container'); const isCompleted = titleContainer.classList.toggle('question-completed'); button.innerHTML = isCompleted ? '<i class="fas fa-undo"></i> Geri Al' : '<i class="fas fa-check"></i> Tamamlandı'; button.classList.toggle('undo', isCompleted); const inputArea = itemDiv.querySelector('.input-area'); if (inputArea) inputArea.style.display = isCompleted ? 'none' : 'block'; saveFormState(); }
    
    function toggleQuestionRemoved(button, id) { const itemDiv = document.getElementById(`fide-item-${id}`); const isRemoved = itemDiv.classList.toggle('question-removed'); const inputArea = itemDiv.querySelector('.input-area'); if(inputArea) inputArea.style.display = isRemoved ? 'none' : 'block'; button.innerHTML = isRemoved ? '<i class="fas fa-undo"></i> Geri Al' : '<i class="fas fa-times-circle"></i> Çıkar'; button.classList.toggle('btn-danger', !isRemoved); button.classList.toggle('btn-primary', isRemoved); const actions = button.closest('.fide-actions'); if(actions) { actions.querySelectorAll('button:not(.remove-btn)').forEach(b => b.disabled = isRemoved); } saveFormState(); }
    
    function addDynamicInput(id, value = '', isCompleted = false) { const container = document.getElementById(`sub-items-container-${id}`); if (!container) return; const newItem = document.createElement('div'); newItem.className = 'dynamic-input-item'; newItem.innerHTML = `<input type="text" placeholder="Eksikliği yazın..." value="${value}"><button class="status-btn btn-sm"><i class="fas fa-check"></i> Tamamlandı</button><button class="delete-bar btn-danger"><i class="fas fa-trash"></i></button>`; const input = newItem.querySelector('input'); const completeButton = newItem.querySelector('.status-btn'); input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addDynamicInput(id); } }); input.addEventListener('blur', saveFormState); completeButton.onclick = () => toggleCompleted(completeButton); newItem.querySelector('.delete-bar').onclick = function() { initiateDeleteItem(this); }; if(isCompleted) toggleCompleted(completeButton); container.prepend(newItem); if (value === '') input.focus(); saveFormState(); }

    // DİĞER FONKSİYONLAR... (Excel, Email, Soru Yöneticisi vb.)
    // ...

    // --- ANA BAŞLATMA FONKSİYONU ---
    async function initializeApp() {
        try {
            const response = await fetch('https://mkotbas.github.io/host/fide_soru_listesi.json');
            if (response.ok) {
                const jsonData = await response.json();
                fideQuestions = jsonData.questions || [];
                productList = jsonData.productList || [];
            } else { throw new Error('Soru dosyası bulunamadı'); }
        } catch (error) {
            fideQuestions = fallbackFideQuestions;
            document.getElementById('initialization-error').style.display = 'block';
        }

        try {
            await auth.signInAnonymously();
            currentUser = auth.currentUser;
            if (!currentUser) throw new Error("Anonim kullanıcı oluşturulamadı.");
            
            // Excel ve diğer lokal verileri yükle
            // loadDideDataFromStorage(); 
            // loadFideDataFromStorage();

            buildForm();
            loadDataFromFirebase();
            setupEventListeners();
        } catch (error) {
            console.error("Firebase Hatası:", error);
            setStatus('<i class="fas fa-exclamation-triangle"></i> Bağlantı Hatası!', 'error');
            alert("Güvenli bulut bağlantısı kurulamadı. Lütfen sayfayı yenileyin ve internet bağlantınızı kontrol edin.");
        }
    }
    
    function setupEventListeners() {
        document.getElementById('clear-all-cloud-data-btn').addEventListener('click', async () => {
             const dogruSifreHash = 'ZmRlMDAx';
             const girilenSifre = prompt("DİKKAT! Buluttaki TÜM raporlar kalıcı olarak silinecektir. Devam etmek için şifreyi girin:");
             if (girilenSifre) {
                if (btoa(girilenSifre) === dogruSifreHash) {
                    if (confirm("Şifre doğru. SON ONAY: Buluttaki tüm veriler silinecek. Emin misiniz?")) {
                        setStatus('<i class="fas fa-sync-alt fa-spin"></i> Siliniyor...', 'connecting');
                        try {
                            await db.ref(`users/${currentUser.uid}/allFideReports`).remove();
                            alert("Buluttaki tüm raporlar başarıyla silindi. Sayfa yenileniyor.");
                            window.location.reload();
                        } catch (error) {
                            alert("Silme işlemi sırasında bir hata oluştu.");
                            setStatus('<i class="fas fa-exclamation-triangle"></i> Silme Hatası!', 'error');
                        }
                    }
                } else {
                    alert("Hatalı şifre!");
                }
             }
        });
        // Diğer butonların event listener'ları buraya eklenecek.
    }
    
    window.onload = initializeApp;
    </script>
</body>
</html>