<div class="module-container" id="bayi-yonetici-container">
    
    <div class="toolbar">
        <button id="btn-yeni-bayi" class="btn btn-primary">
            <i class="fas fa-plus"></i> Yeni Bayi Ekle
        </button>
        
        <div class="filter-group">
            <label for="kontrol-filtresi">Kontrol Mekanizması:</label>
            <select id="kontrol-filtresi" class="form-control">
                <option value="all">Tüm Bayiler</option>
                <option value="no_bolge">Bölgesi Olmayanlar</option>
                <option value="no_sehir">Şehri Olmayanlar</option>
                <option value="no_ilce">İlçesi Olmayanlar</option>
                <option value="no_bayiKodu">Bayi Kodu Olmayanlar</option>
                <option value="no_bayiAdi">Bayi Adı Olmayanlar</option>
                <option value="no_yonetmen">Bayi Yönetmeni Olmayanlar</option>
                <option value="no_email">Mail Adresi Olmayanlar</option>
                <option value="no_uzman">Denetim Uzmanı Olmayanlar</option>
            </select>
        </div>
    </div>

    <fieldset class="report-fieldset">
        <legend>Raporlama & Veri Yönetimi</legend>
        <div class="fieldset-content-wrapper">
            
            <div class="report-export-section">
                <strong>Raporlama & Görüntüleme (Dışa Aktar)</strong>
                <p>Görüntülemek veya Excel'e aktarmak istediğiniz sütunları seçin (Hiçbiri seçilmezse görünüm sıfırlanır):</p>
                <div id="column-checkboxes" class="checkbox-group">
                    </div>
                <div class="report-actions">
                    <button id="btn-view-selected" class="btn btn-secondary">
                        <i class="fas fa-eye"></i> Seçilenleri Görüntüle
                    </button>
                    <button id="btn-export-excel" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Seçilenleri Excel'e Aktar
                    </button>
                </div>
            </div>

            <div class="report-import-section">
                <strong>Excel'den Bayi Aktar (İçe Aktar)</strong>
                <p>Sütun eşleştirmesi yaparak toplu bayi verisi yükleyin. Bu özellik `XLSX.js` kütüphanesini kullanır.</p>
                <div class="report-actions">
                    <button id="btn-open-import-modal" class="btn btn-info">
                        <i class="fas fa-file-upload"></i> Bayi Verisi Yükle
                    </button>
                </div>
            </div>

            <div class="report-assign-section">
                <strong>Toplu Denetim Uzmanı Atama</strong>
                <p>'Atanmamış' bayileri filtrelere göre süzerek toplu olarak bir denetim uzmanı atayın.</p>
                <div class="report-actions">
                    <button id="btn-open-bulk-assign-modal" class="btn btn-warning">
                        <i class="fas fa-users-cog"></i> Filtreye Göre Atama Yap
                    </button>
                </div>
            </div>

        </div>
    </fieldset>

    <div class="table-container">
        <div id="loading-spinner" class="spinner" style="display: none;"></div>
        <table id="bayi-table">
            <thead>
                <tr>
                    <th style="width: 10%;" data-column="bolge">Bölge</th>
                    <th style="width: 10%;" data-column="sehir">Şehir</th>
                    <th style="width: 10%;" data-column="ilce">İlçe</th>
                    <th style="width: 10%;" data-column="bayiKodu">Bayi Kodu</th>
                    <th style="width: 15%;" data-column="bayiAdi">Bayi Adı</th>
                    <th style="width: 13%;" data-column="yonetmen">Bayi Yönetmeni</th>
                    <th style="width: 12%;" data-column="email">Mail</th>
                    <th style="width: 12%;" data-column="sorumlu_kullanici_email">Denetim Uzmanı</th>
                    <th style="width: 8%; min-width: 120px;" data-column="eylemler">Eylemler</th>
                </tr>
                
                <tr class="search-row">
                    <th data-column="bolge"><input type="text" placeholder="Bölge ara..." class="column-search-input" data-column="bolge"></th>
                    <th data-column="sehir"><input type="text" placeholder="Şehir ara..." class="column-search-input" data-column="sehir"></th>
                    <th data-column="ilce"><input type="text" placeholder="İlçe ara..." class="column-search-input" data-column="ilce"></th>
                    <th data-column="bayiKodu"><input type="text" placeholder="Kod ara..." class="column-search-input" data-column="bayiKodu"></th>
                    <th data-column="bayiAdi"><input type="text" placeholder="Bayi Adı ara..." class="column-search-input" data-column="bayiAdi"></th>
                    <th data-column="yonetmen"><input type="text" placeholder="Yönetmen ara..." class="column-search-input" data-column="yonetmen"></th>
                    <th data-column="email"><input type="text" placeholder="Mail ara..." class="column-search-input" data-column="email"></th>
                    <th data-column="sorumlu_kullanici_email"><input type="text" placeholder="Uzman ara..." class="column-search-input" data-column="sorumlu_kullanici_email"></th>
                    <th data-column="eylemler"></th>
                </tr>

            </thead>
            <tbody id="bayi-table-body">
                </tbody>
        </table>
    </div>

    <div id="bayi-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="modal-title">Bayi Bilgileri</h3>
            <form id="bayi-form">
                <input type="hidden" id="bayi-id" name="bayiId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="bayiKodu">Bayi Kodu (Zorunlu)</label>
                        <input type="text" id="bayiKodu" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="bayiAdi">Bayi Adı</label>
                        <input type="text" id="bayiAdi" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="bolge">Bölge</label>
                        <input type="text" id="bolge" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="sehir">Şehir</label>
                        <input type="text" id="sehir" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="ilce">İlçe</label>
                        <input type="text" id="ilce" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="yonetmen">Bayi Yönetmeni</label>
                        <input type="text" id="yonetmen" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="email">Mail Adresi</label>
                        <input type="email" id="email" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="sorumlu_kullanici">Denetim Uzmanı</label>
                        <select id="sorumlu_kullanici" class="form-control">
                            </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="btn-modal-cancel" class="btn btn-danger">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-large">
            <h3 id="import-modal-title">Excel Bayi Aktarma Sihirbazı</h3>
            
            <div id="import-step-1">
                <h4>Adım 1: Excel Dosyasını Yükleyin</h4>
                <p>Lütfen <code>.xlsx</code> veya <code>.xls</code> formatında, ilk satırı sütun başlıklarını içeren dosyayı seçin.</p>
                <div class="form-group">
                    <label for="excel-file-input">Excel Dosyası:</label>
                    <input type="file" id="excel-file-input" class="form-control" accept=".xlsx, .xls, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                </div>
                <div class="form-actions">
                    <button type="button" id="btn-import-modal-cancel-1" class="btn btn-danger">İptal</button>
                    <button type="button" id="btn-process-excel" class="btn btn-primary" disabled>Dosyayı İşle & Eşleştirmeye Geç</button>
                </div>
            </div>

            <div id="import-step-2" style="display: none;">
                <h4>Adım 2: Sütunları Eşleştirin</h4>
                <p>Excel dosyanızdaki sütun başlıklarını (sol taraf), veritabanındaki hedef alanlarla (sağ taraf) eşleştirin. Eşleşmeyen sütunlar (veya 'Eşleştirme / Boş Geç' seçilenler) içe aktarılmayacaktır.</p>
                
                <div id="mapping-container" class="mapping-container-class">
                    </div>

                <div class="global-assignment-container">
                    <div class="mapping-row global-assignment-row">
                        <label class="excel-column-label global-label">
                            <i class="fas fa-users"></i>
                            Toplu Denetim Uzmanı Ataması
                        </label>
                        <i class="fas fa-arrow-right"></i>
                        <select id="import-global-user-select" class="form-control db-field-select">
                            <option value="">İçe Aktarılan Tüm Bayileri Bu Kullanıcıya Ata (Opsiyonel)</option>
                            </select>
                    </div>
                    <p class="global-assignment-note">
                        Eğer buradan bir kullanıcı seçerseniz, Excel'deki 'Denetim Uzmanı' sütun eşleştirmesi <strong>dikkate alınmaz</strong> ve tüm bayiler seçtiğiniz bu kullanıcıya atanır.
                    </p>
                </div>
                
                <div class="note note-warning" id="import-warning" style="display: none;">
                    <strong>Zorunlu Alan Uyarısı:</strong> 
                    İçe aktarma işleminin başlaması için <code>Bayi Kodu</code> alanını eşleştirmeniz zorunludur.
                    <br><br>
                    Eğer mevcut bir <code>bayiKodu</code> ile eşleşen veri bulunursa, o bayinin bilgileri güncellenecektir. Eşleşmezse yeni bayi olarak eklenecektir.
                </div>
                
                <div class="form-actions">
                    <button type="button" id="btn-import-modal-cancel-2" class="btn btn-danger">İptal</Click>
                    <button type="button" id="btn-execute-import" class="btn btn-success" disabled>
                        <i class="fas fa-check"></i> Eşleştirmeyi Onayla ve İçe Aktar
                    </button>
                </div>
            </div>

             <div id="import-step-3" style="display: none;">
                <h4>Adım 3: İçe Aktarma Sonucu</h4>
                <div id="import-results" class="import-results-class">
                    </div>
                <div class="form-actions">
                    <button type="button" id="btn-import-modal-close" class="btn btn-primary">Kapat</button>
                </div>
            </div>

            <div id="import-loading-overlay" class="modal-loading-overlay" style="display: none;">
                <div class="spinner"></div>
                <p id="import-loading-text">İşlem yürütülüyor, lütfen bekleyin...</p>
            </div>

        </div>
    </div>

    <div id="bulk-assign-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="bulk-assign-modal-title">Filtreye Göre Toplu Denetim Uzmanı Atama</h3>
            <p>Bu araç, <strong>'Atanmamış'</strong> (Denetim Uzmanı olmayan) bayileri seçtiğiniz filtrelere göre süzerek, onlara toplu olarak bir Denetim Uzmanı atamanızı sağlar.</p>
            
            <h4>Adım 1: Atanmamış Bayileri Filtrele (Opsiyonel)</h4>
            <p>Filtreleri boş bırakırsanız (hiçbir kutucuğu seçmezseniz), atanmamış <strong>tüm</strong> bayiler hedeflenir.</p>
            
            <div class="bulk-assign-filters">
                <div class="form-group">
                    <label for="bulk-assign-filter-bolge">Bölge</label>
                    <div id="bulk-assign-filter-bolge" class="checkbox-list-container">
                        </div>
                </div>
                <div class="form-group">
                    <label for="bulk-assign-filter-sehir">Şehir</label>
                    <div id="bulk-assign-filter-sehir" class="checkbox-list-container">
                        </div>
                </div>
                <div class="form-group">
                    <label for="bulk-assign-filter-yonetmen">Bayi Yönetmeni</label>
                    <div id="bulk-assign-filter-yonetmen" class="checkbox-list-container">
                        </div>
                </div>
            </div>
            <h4>Adım 2: Denetim Uzmanı Seç (Zorunlu)</h4>
            <div class="form-group" id="bulk-assign-user-select-container">
                <label for="bulk-assign-user-select">Atanacak Denetim Uzmanı</label>
                <select id="bulk-assign-user-select" class="form-control" required>
                    <option value="">Lütfen bir kullanıcı seçin...</option>
                    </select>
            </div>

            <div class="form-actions">
                <button type="button" id="btn-bulk-assign-cancel" class="btn btn-danger">İptal</button>
                <button type="button" id="btn-execute-bulk-assign" class="btn btn-success">
                    <i class="fas fa-check"></i> Atamayı Tamamla
                </button>
            </div>
            
            <div id="bulk-assign-loading-overlay" class="modal-loading-overlay" style="display: none;">
                <div class="spinner"></div>
                <p id="bulk-assign-loading-text">İşlem yürütülüyor, lütfen bekleyin...</p>
            </div>
        </div>
    </div>
    </div>