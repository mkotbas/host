(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const o of l.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function n(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(a){if(a.ep)return;a.ep=!0;const l=n(a);fetch(a.href,l)}})();(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();let X=[],Q=[],N=[],A=[],M=[],me=[],K=[],ye={},Z=[],h=null,U=null,J=!1;const ae=[{id:0,type:"standard",title:"HATA: Sorular buluttan yüklenemedi."}],Be=["","Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];function pe(e){X=e}function fe(e){Q=e}function Ie(e){N=e}function R(e){A=e}function Se(e){M=e}function Le(e){me=e}function $e(e){K=e}function Ae(e){ye=e}function le(e){Z=e}function ee(e){h=e}function z(e){U=e}function oe(e){J=e}function Y(e){const t=document.getElementById("loading-overlay");if(t){const n=t.querySelector("i");n&&(n.className="fas fa-spinner fa-spin",n.style.fontSize="",n.style.marginBottom="");const i=t.querySelector("p");i.textContent=e,i.style.textAlign="",i.style.padding="",i.style.maxWidth="",i.style.boxSizing="",i.style.wordWrap="",i.style.overflowWrap="",i.style.width="",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="white",t.style.flexDirection="column",t.style.justifyContent="center",t.style.alignItems="center",t.style.display="flex"}}function H(){const e=document.getElementById("loading-overlay");e&&(e.style.display="none")}function P(e){const t=document.getElementById("loading-overlay");if(t){const n=t.querySelector("i");n&&(n.className="fas fa-lock",n.style.fontSize="40px",n.style.marginBottom="20px");const i=t.querySelector("p");i.textContent=e,i.style.width="90%",i.style.maxWidth="90%",i.style.textAlign="center",i.style.padding="0",i.style.boxSizing="border-box",i.style.wordWrap="break-word",i.style.overflowWrap="break-word",t.style.backgroundColor="rgba(255, 0, 0, 0.7)",t.style.color="white",t.style.flexDirection="column",t.style.justifyContent="center",t.style.alignItems="center",t.style.display="flex",t.style.zIndex="2000"}}let s;function _e(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function Te(){const e=navigator.userAgent;let t="Unknown OS",n="Unknown Browser";return/Windows/.test(e)?t="Windows":/Macintosh/.test(e)?t="MacOS":/iPhone|iPad|iPod/.test(e)?t="iOS":/Android/.test(e)?t="Android":/Linux/.test(e)&&(t="Linux"),/Edg/.test(e)?n="Edge":/Chrome/.test(e)&&!/Edg/.test(e)?n="Chrome":/Safari/.test(e)&&!/Chrome/.test(e)?n="Safari":/Firefox/.test(e)&&(n="Firefox"),`${n} on ${t}`}function qe(){const e=new Uint32Array(4);return window.crypto.getRandomValues(e),Array.from(e,t=>t.toString(36)).join("-").toUpperCase()}function De(e){s=e}async function ze(){if(!s||!s.authStore.isValid)return;const e=s.authStore.model.id,t=localStorage.getItem("myAppDeviceKey");try{if((await s.collection("users").getOne(e)).is_banned===!0){console.warn("Hesap zaten kilitli. Oturum sonlandırılıyor."),P("Hesabınız bir yönetici tarafından kilitlenmiştir. Sistemden çıkış yapılıyor..."),E(),setTimeout(()=>window.location.reload(),3e3);return}s.collection("users").subscribe(e,function(n){n.record&&n.record.is_banned===!0&&(console.warn("Kullanıcı kilitlendi (is_banned=true). Oturum sonlandırılıyor."),P("Hesabınız bir yönetici tarafından kilitlenmiştir. Sistemden çıkış yapılıyor..."),E(),setTimeout(()=>window.location.reload(),3e3))})}catch(n){console.error("Kullanıcı (ban) dinlemesi başlatılamadı:",n)}if(s.authStore.model.role==="client"&&t)try{const n=await s.collection("user_devices").getFirstListItem(`user="${e}" && device_key="${t}"`);if(n.is_locked===!0){console.warn("Cihaz zaten kilitli. Oturum sonlandırılıyor."),P("Bu cihaz bir yönetici tarafından kilitlenmiştir. Sistemden çıkış yapılıyor..."),E(),setTimeout(()=>window.location.reload(),3e3);return}s.collection("user_devices").subscribe(n.id,function(i){i.record&&i.record.is_locked===!0&&(console.warn("Cihaz kilitlendi (is_locked=true). Oturum sonlandırılıyor."),P("Bu cihaz bir yönetici tarafından kilitlenmiştir. Sistemden çıkış yapılıyor..."),E(),setTimeout(()=>window.location.reload(),3e3))})}catch(n){console.error("Cihaz (lock) dinlemesi başlatılamadı veya cihaz kaydı bulunamadı:",n),P("Cihaz kaydınız bulunamadı veya geçersiz. Güvenlik nedeniyle çıkış yapılıyor..."),E(),localStorage.removeItem("myAppDeviceKey"),setTimeout(()=>window.location.reload(),3e3)}}async function Ke(){if(le([]),!(!s||!s.authStore.isValid))try{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1).toISOString().split("T")[0]+" 00:00:00",n=`${e.getFullYear()}-${e.getMonth()}`;let i=[];try{i=(await s.collection("denetim_geri_alinanlar").getFullList({filter:`yil_ay = "${n}"`,expand:"bayi"})).map(l=>l.expand&&l.expand.bayi?l.expand.bayi.bayiKodu:null).filter(Boolean)}catch(l){l.status!==404&&console.error("Geri alınan bayi bilgisi yüklenemedi:",l)}const a=(await s.collection("denetim_raporlari").getFullList({filter:`denetimTamamlanmaTarihi >= "${t}"`,expand:"bayi"})).map(l=>l.expand.bayi.bayiKodu).filter(l=>!i.includes(l));le(a)}catch(e){console.error("Bu ay denetlenen bayi verileri yüklenirken hata oluştu:",e)}}async function Pe(){if(!(!s||!s.authStore.isValid)){try{const e=await s.collection("excel_verileri").getFirstListItem('tip="dide"');e&&(e.dosyaAdi&&(document.getElementById("file-name").textContent=`Buluttan yüklendi: ${e.dosyaAdi}`),pe(e.veri))}catch(e){e.status!==404&&console.error("Buluttan DiDe Excel verisi yüklenirken hata oluştu:",e)}try{const e=await s.collection("excel_verileri").getFirstListItem('tip="fide"');e&&(e.dosyaAdi&&(document.getElementById("fide-file-name").textContent=`Buluttan yüklendi: ${e.dosyaAdi}`),fe(e.veri))}catch(e){e.status!==404&&console.error("Buluttan FiDe Excel verisi yüklenirken hata oluştu:",e)}}}async function Ce(){if(!s||!s.authStore.isValid)return R(ae),!1;Y("Veriler yükleniyor...");try{await Ke();const e=(await s.collection("ayarlar").getFullList()).find(a=>a.anahtar==="fideQuestionsData");if(e){const a=e.deger;R(a.questions||[]),Se(a.productList||[])}else throw new Error("fideQuestionsData bulunamadı");const t=A.find(a=>a.type==="pop_system");t&&(Le(t.popCodes||[]),$e(t.expiredCodes||[]));const n=await s.collection("bayiler").getFullList({sort:"bayiAdi"});Ie(n);const i={};return n.forEach(a=>{a.email&&(i[a.bayiKodu]=a.email)}),Ae(i),await Pe(),!0}catch(e){return console.error("Başlangıç verileri okunurken hata oluştu:",e),R(ae),document.getElementById("initialization-error").style.display="block",!1}finally{H()}}async function ge(e,t=!1){if(!h||!s||!s.authStore.isValid)return;const n=String(h.bayiKodu),i=N.find(o=>o.bayiKodu===n);if(!i){console.error("Kaydedilecek bayi veritabanında bulunamadı!");return}if(t)try{const o=new Date,r=`${o.getFullYear()}-${o.getMonth()}`,u=await s.collection("denetim_geri_alinanlar").getFirstListItem(`yil_ay="${r}" && bayi="${i.id}"`);await s.collection("denetim_geri_alinanlar").delete(u.id)}catch(o){o.status!==404&&console.error("Geri alınmış denetim kaydı temizlenirken bir hata oluştu:",o)}const a={bayi:i.id,soruDurumlari:e.questions_status,user:s.authStore.model.id},l=Z.includes(n);t&&!l&&(a.denetimTamamlanmaTarihi=new Date().toISOString()),t&&Y("Rapor kaydediliyor...");try{if(U)await s.collection("denetim_raporlari").update(U,a);else{const o=await s.collection("denetim_raporlari").create(a);z(o.id)}}catch(o){console.error("PocketBase'e yazma hatası:",o),t&&alert("Rapor kaydedilirken bir hata oluştu!")}finally{t&&H()}}async function Oe(e){if(!s||!s.authStore.isValid)return null;Y("Rapor yükleniyor...");try{const t=N.find(i=>i.bayiKodu===e);if(!t)throw new Error("Bayi bulunamadı.");const n=await s.collection("denetim_raporlari").getFirstListItem(`bayi="${t.id}"`,{sort:"-created"});return z(n.id),n.soruDurumlari}catch(t){return t.status===404?(console.log("Bu bayi için kaydedilmiş bir rapor bulunamadı. Temiz form açılıyor."),z(null)):console.error("PocketBase'den rapor okuma hatası:",t),null}finally{H()}}async function re(e){if(!s.authStore.isValid){alert("Bu işlem için giriş yapmış olmalısınız.");return}try{const t=await s.collection("excel_verileri").getFirstListItem(`tip="${e}"`);await s.collection("excel_verileri").delete(t.id),alert(`${e.toUpperCase()} Excel verisi buluttan temizlendi. Sayfa yenileniyor.`),window.location.reload()}catch(t){t.status===404?alert(`Silinecek ${e.toUpperCase()} verisi bulunamadı.`):(console.error(`${e.toUpperCase()} verisi silinirken bir hata oluştu:`,t),alert("Veri silinirken bir hata oluştu."))}}async function be(e,t){if(!s)return{success:!1,message:"Veritabanı bağlantısı kurulamadı."};let n;try{const i=await s.collection("users").authWithPassword(e,t);n=await s.collection("users").getOne(i.record.id)}catch(i){return console.error("Login error:",i),{success:!1,message:"E-posta veya şifre hatalı."}}try{if(n.is_banned===!0)return E(),{success:!1,message:"Bu hesap yönetici tarafından kilitlenmiştir."};if(n.role==="admin")return{success:!0,message:"Yönetici girişi başarılı."};if(n.mobile_access===!1&&_e())return E(),{success:!1,message:"Bu hesaptan mobil cihaz ile giriş izni yoktur."};const i=localStorage.getItem("myAppDeviceKey"),a=Te();if(i)try{const l=await s.collection("user_devices").getFirstListItem(`user="${n.id}" && device_key="${i}"`);return l.is_locked?(E(),{success:!1,message:"Bu cihaz yönetici tarafından kilitlenmiştir."}):(await s.collection("user_devices").update(l.id,{last_login:new Date().toISOString(),device_info:a}),{success:!0,message:"Giriş başarılı."})}catch{return localStorage.removeItem("myAppDeviceKey"),be(e,t)}else{const l=n.device_limit||1;if((await s.collection("user_devices").getFullList({filter:`user="${n.id}"`})).length>=l)return E(),{success:!1,message:`Kişisel cihaz limitiniz (${l}) dolmuştur. Yeni bir cihaz ekleyemezsiniz. Lütfen yöneticinizle iletişime geçin.`};const o=qe();return await s.collection("user_devices").create({user:n.id,device_key:o,device_info:a,last_login:new Date().toISOString(),is_locked:!1}),localStorage.setItem("myAppDeviceKey",o),{success:!0,message:"Yeni cihaz kaydedildi ve giriş yapıldı."}}}catch(i){return console.error("Login security check error:",i),E(),{success:!1,message:"Güvenlik kontrolü sırasında bir hata oluştu."}}}function E(){s&&s.authStore.clear()}let x;function Fe(e){x=e}async function Ne(e,t){if(e.length<2)return alert("DiDe Excel dosyası beklenen formatta değil (en az 2 satır gerekli)."),null;let n=e.findIndex(c=>c.some(d=>typeof d=="string"&&d.trim()==="Bayi Kodu"));if(n===-1)return alert('DiDe Excel dosyasında "Bayi Kodu" içeren bir başlık satırı bulunamadı.'),null;const i=e[n].map(c=>typeof c=="string"?c.trim():c),a=e.slice(n+1),l=i.indexOf("Bayi Kodu"),o=i.indexOf("Bayi"),r=i.indexOf("Bayi Yönetmeni");if([l,o,r].includes(-1))return alert('DiDe Excel dosyasında "Bayi Kodu", "Bayi" veya "Bayi Yönetmeni" sütunlarından biri bulunamadı.'),null;const u=a.map(c=>{if(!c[l])return null;const d={};return i.forEach((g,m)=>{const y=parseInt(g);!isNaN(y)&&y>=1&&y<=12&&c[m]!==null&&c[m]!==void 0&&(d[y]=c[m])}),{"Bayi Kodu":c[l],Bayi:c[o],"Bayi Yönetmeni":c[r],scores:d}}).filter(c=>c);if(x&&x.authStore.isValid){const c={tip:"dide",dosyaAdi:t,veri:u};try{const d=await x.collection("excel_verileri").getFirstListItem('tip="dide"');await x.collection("excel_verileri").update(d.id,c)}catch(d){if(d.status===404)await x.collection("excel_verileri").create(c);else return console.error("DiDe verisi kaydedilirken hata:",d),alert("DiDe verisi buluta kaydedilirken bir hata oluştu."),null}alert("DiDe puan dosyası başarıyla işlendi ve buluta kaydedildi.")}return u}async function Me(e,t){if(e.length<3)return alert("FiDe Excel dosyası beklenen formatta değil (en az 3 satır gerekli)."),null;const n=new Date().getFullYear();let i=-1;for(let m=0;m<e.length;m++)if(e[m].some(y=>String(y).trim()==n)){i=m;break}if(i===-1)return alert(`FiDe Excel dosyasında '${n}' yılını içeren bir satır bulunamadı.`),null;const a=e[i].reduce((m,y)=>(m.lastKnown=y!=null&&String(y).trim()!==""?String(y).trim():m.lastKnown,m.result.push(m.lastKnown),m),{result:[],lastKnown:null}).result;let l=i+1;if(l>=e.length)return alert("FiDe Excel dosyasında ay bilgileri (yıl satırının altında) bulunamadı."),null;const o=e[l];let r=e.findIndex(m=>m.some(y=>typeof y=="string"&&y.trim()==="Bayi Kodu"));if(r===-1)return alert('FiDe Excel dosyasında "Bayi Kodu" içeren bir başlık satırı bulunamadı.'),null;const u=e[r].map(m=>typeof m=="string"?m.trim():m),c=e.slice(r+1),d=u.indexOf("Bayi Kodu");if(d===-1)return alert('FiDe Excel dosyasında "Bayi Kodu" sütunu bulunamadı.'),null;const g=c.map(m=>{if(!m[d])return null;const y={};for(let w=0;w<a.length;w++)if(a[w]==n){const _=parseInt(o[w]);!isNaN(_)&&_>=1&&_<=12&&m[w]!==null&&m[w]!==void 0&&m[w]!==""&&(y[_]=m[w])}return{"Bayi Kodu":m[d],scores:y}}).filter(m=>m);if(x&&x.authStore.isValid){const m={tip:"fide",dosyaAdi:t,veri:g};try{const y=await x.collection("excel_verileri").getFirstListItem('tip="fide"');await x.collection("excel_verileri").update(y.id,m)}catch(y){if(y.status===404)await x.collection("excel_verileri").create(m);else return console.error("FiDe verisi kaydedilirken hata:",y),alert("FiDe verisi buluta kaydedilirken bir hata oluştu."),null}alert("FiDe puan dosyası başarıyla işlendi ve buluta kaydedildi.")}return g}async function se(e,t){const n=e.target.files[0];if(!n)return!1;const i=n.name,a=t==="dide"?document.getElementById("file-name"):document.getElementById("fide-file-name");return a.textContent=`Yüklü dosya: ${i}`,Y("Excel dosyası işleniyor..."),new Promise(l=>{const o=new FileReader;o.readAsArrayBuffer(n),o.onload=async function(r){try{const u=new Uint8Array(r.target.result),c=XLSX.read(u,{type:"array"}),d=c.SheetNames[0],g=c.Sheets[d],m=XLSX.utils.sheet_to_json(g,{header:1,defval:""});let y;t==="dide"?(y=await Ne(m,i),y&&pe(y)):(y=await Me(m,i),y&&fe(y)),l(!!y)}catch(u){alert("Excel dosyası okunurken bir hata oluştu."),console.error("Excel okuma hatası:",u),l(!1)}finally{H()}},o.onerror=()=>{alert("Dosya okunamadı."),l(!1)}})}let L,ce;function k(){clearTimeout(ce),ce=setTimeout(()=>{J&&h&&ge(ke())},800)}function Ye(e){L=e}function he(e){const t=e.toUpperCase();return t.includes("TSHIRT")||t.includes("HIRKA")?"Adet":"Paket"}function He(e){let t="",n="",i=e.isArchived?"archived-item":"";if(e.type==="standard"){t=`<div class="fide-actions">
            <button class="add-item-btn btn-sm" data-action="add-input" data-container-id="fide${e.id}" title="Bu maddeyle ilgili yeni bir eksiklik satırı ekler."><i class="fas fa-plus"></i> Yeni Eksik Ekle</button>
            <button class="status-btn btn-sm" data-action="toggle-complete" data-question-id="${e.id}" title="Bu soruyu 'Tamamlandı' olarak işaretler. Geri alınabilir."><i class="fas fa-check"></i> Tamamlandı</button>
            <button class="remove-btn btn-danger btn-sm" data-action="toggle-remove" data-question-id="${e.id}" title="Bu soruyu e-posta raporundan tamamen çıkarır. Geri alınabilir."><i class="fas fa-times-circle"></i> Çıkar</button>
            </div>`;let a=(e.staticItems||[]).map(l=>`<div class="static-item"><div class="content">${l}</div><button class="delete-bar btn-danger" data-action="delete-item" title="Bu satırı silmek için tıklayın. 4 saniye içinde geri alınabilir."><i class="fas fa-trash"></i></button></div>`).join("");n=`<div class="input-area"><div id="sub-items-container-fide${e.id}">${a}</div></div>`}else if(e.type==="product_list"){t=`<div class="fide-actions">
            <button class="add-item-btn btn-sm" data-action="add-input" data-container-id="fide${e.id}_pleksi" title="Pleksi kullanımıyla ilgili yeni bir eksiklik satırı ekler."><i class="fas fa-plus"></i> Yeni Ekle</button>
            <button class="status-btn btn-sm" data-action="toggle-complete" data-question-id="${e.id}" title="Bu soruyu 'Tamamlandı' olarak işaretler. Geri alınabilir."><i class="fas fa-check"></i> Tamamlandı</button>
            <button class="remove-btn btn-danger btn-sm" data-action="toggle-remove" data-question-id="${e.id}" title="Bu soruyu e-posta raporundan tamamen çıkarır. Geri alınabilir."><i class="fas fa-times-circle"></i> Çıkar</button>
            </div>`;let a="",l=!1;M.forEach(o=>{o.type==="header"?(l&&(a+="</optgroup>"),a+=`<optgroup label="${o.name}">`,l=!0):a+=`<option value="${o.code}">${o.code} - ${o.name}</option>`}),l&&(a+="</optgroup>"),n=`<div class="input-area"><b><i>Sipariş verilmesi gerekenler:</i></b>
            <div class="product-adder">
                <select id="product-selector"><option value="">-- Malzeme Seçin --</option>${a}</select>
                <input type="number" id="product-qty" placeholder="Adet" min="1" value="1">
                <button class="btn-success btn-sm" data-action="add-product" title="Seçili malzemeyi ve adedini aşağıdaki sipariş listesine ekler."><i class="fas fa-plus"></i> Ekle</button>
            </div>
            <div id="selected-products-list"></div><hr><b class="plexi-header"><i>Pleksiyle sergilenmesi gerekenler veya Yanlış Pleksi malzeme ile kullanılanlar:</i></b>
            <div id="sub-items-container-fide${e.id}_pleksi"></div></div>`}else e.type==="pop_system"&&(t=`<div class="fide-actions">
            <button class="status-btn btn-sm" data-action="toggle-complete" data-question-id="${e.id}" title="Bu soruyu 'Tamamlandı' olarak işaretler. Geri alınabilir."><i class="fas fa-check"></i> Tamamlandı</button>
            <button class="remove-btn btn-danger btn-sm" data-action="toggle-remove" data-question-id="${e.id}" title="Bu soruyu e-posta raporundan tamamen çıkarır. Geri alınabilir."><i class="fas fa-times-circle"></i> Çıkar</button>
            </div>`,n=`<div class="input-area"><div class="pop-container" id="popCodesContainer"></div><div class="warning-message" id="expiredWarning">Seçiminizde süresi dolmuş kodlar bulunmaktadır.</div>
            <div class="pop-button-container">
                <button class="btn-success btn-sm" data-action="pop-copy" title="Seçili olan geçerli POP kodlarını panoya kopyalar.">Kopyala</button>
                <button class="btn-danger btn-sm" data-action="pop-clear" title="Tüm POP kodu seçimlerini temizler.">Temizle</button>
                <button class="btn-primary btn-sm" data-action="pop-expired" title="Süresi dolmuş olan tüm POP kodlarını otomatik olarak seçer.">Bitenler</button>
                <button class="btn-primary btn-sm" data-action="pop-email" title="Seçili POP kodları için bir e-posta taslağı penceresi açar.">E-Posta</button>
            </div></div>`);return`<div class="fide-item ${i}" id="fide-item-${e.id}"><div class="fide-title-container"><p><span class="badge">FiDe ${e.id}</span> ${e.title}</p></div>${n}${t}</div>`}function ke(){let e={questions_status:{}};return A.forEach(t=>{const n=document.getElementById(`fide-item-${t.id}`);if(!n)return;const i=n.classList.contains("question-removed"),a=n.querySelector(".fide-title-container"),l=a?a.classList.contains("question-completed"):!1,o={removed:i,completed:l,dynamicInputs:[],selectedProducts:[],selectedPops:[]};if(t.type==="standard"){const r=document.getElementById(`sub-items-container-fide${t.id}`);r&&Array.from(r.childNodes).reverse().forEach(u=>{if(u.classList&&u.classList.contains("dynamic-input-item")){const c=u.querySelector('input[type="text"]'),d=c.value.trim();d&&o.dynamicInputs.push({text:d,completed:c.classList.contains("completed")})}})}else if(t.type==="product_list"){document.querySelectorAll(`#fide-item-${t.id} #selected-products-list .selected-product-item`).forEach(u=>{o.selectedProducts.push({code:u.dataset.code,qty:u.dataset.qty})});const r=document.getElementById(`sub-items-container-fide${t.id}_pleksi`);r&&Array.from(r.childNodes).reverse().forEach(u=>{if(u.classList&&u.classList.contains("dynamic-input-item")){const c=u.querySelector('input[type="text"]'),d=c.value.trim();d&&o.dynamicInputs.push({text:d,completed:c.classList.contains("completed")})}})}else t.type==="pop_system"&&(o.selectedPops=Array.from(document.querySelectorAll(`#fide-item-${t.id} .pop-checkbox:checked`)).map(r=>r.value));e.questions_status[t.id]=o}),e}function de(){const e=document.getElementById("connection-status-switch"),t=document.getElementById("connection-status-text"),n=J&&typeof L<"u"&&L&&L.authStore.isValid;e.classList.toggle("connected",n),e.classList.toggle("disconnected",!n),t.textContent=n?"Buluta Bağlı":"Bağlı Değil"}function Ge(){const e=document.getElementById("email-draft-container");e&&e.remove(),document.getElementById("dide-upload-card").style.display="block",document.getElementById("form-content").style.display="block";const t=document.getElementById("generate-email-btn");t&&(t.style.display="block")}function C(){z(null);const e=document.getElementById("form-content");e&&(e.innerHTML=""),W()}function W(){const e=document.getElementById("form-content");if(!e)return;e.innerHTML="";let t="";A.forEach(i=>{i.isArchived||(t+=He(i))}),e.innerHTML=t;const n=document.getElementById("popCodesContainer");n&&Ue(n)}function je(){ee(null),z(null);const e=document.getElementById("store-search-input");e&&(e.value=""),C(),$(!1)}async function Ve(){if(!h){alert("Lütfen denetime başlamadan önce bir bayi seçin!");return}let e="<p>{YONETMEN_ADI} Bey Merhaba,</p><p>Ziyaret etmiş olduğum {BAYI_BILGISI} bayi karnesi aşağıdadır.</p><p><br></p>{DENETIM_ICERIGI}<p><br></p>{PUAN_TABLOSU}";if(L&&L.authStore.isValid)try{const p=await L.collection("ayarlar").getFirstListItem('anahtar="emailTemplate"');p&&p.deger&&(e=p.deger)}catch(p){p.status!==404&&console.error("E-posta şablonu buluttan yüklenemedi.",p)}const t=ke();await ge(t,!0);const n=X.find(p=>String(p["Bayi Kodu"])===String(h.bayiKodu)),i=Q.find(p=>String(p["Bayi Kodu"])===String(h.bayiKodu));if(!n){alert("Seçilen bayi için DiDe verisi bulunamadı. Lütfen DiDe Excel dosyasını yükleyin.");return}const a=ye[h.bayiKodu]||null,l=a?` <a href="mailto:${a}" style="background-color:#e0f2f7; color:#005f73; font-weight:bold; padding: 1px 6px; border-radius: 4px; text-decoration:none;">@${a}</a>`:"",o=(n["Bayi Yönetmeni"]||"").split(" ")[0],r=h.bayiAdi.length>20?h.bayiAdi.substring(0,20)+"...":h.bayiAdi;let u="";A.forEach(p=>{var B;const j=document.getElementById(`fide-item-${p.id}`);if(!j||j.classList.contains("question-removed"))return;const F=(B=j.querySelector(".fide-title-container"))==null?void 0:B.classList.contains("question-completed");let S="";if(p.type==="standard"){const I=document.getElementById(`sub-items-container-fide${p.id}`);if(I){const b=[];Array.from(I.childNodes).reverse().forEach(f=>{if(f.classList&&(f.classList.contains("static-item")||f.classList.contains("dynamic-input-item"))){if(f.classList.contains("is-deleting"))return;let v,q=!1,V="";if(f.classList.contains("static-item"))v=f.querySelector(".content").innerHTML,V="static";else{const ne=f.querySelector('input[type="text"]');v=ne.value.trim(),q=ne.classList.contains("completed"),V="dynamic"}v&&b.push({text:v,completed:q,type:V})}});let T=b.some(f=>f.type==="dynamic")?b.filter(f=>f.type==="dynamic"||f.type==="static"&&f.text.includes("<a href")):b.filter(f=>f.type==="static");T.length>0&&(T.sort((f,v)=>(f.text.includes("<a href")?1:-1)-(v.text.includes("<a href")?1:-1)),S=`<ul>${T.map(f=>f.completed?`<li>${f.text} <span style="background-color:#dcfce7; color:#166534; font-weight:bold; padding: 1px 6px; border-radius: 4px;">Tamamlandı</span></li>`:`<li>${f.text}</li>`).join("")}</ul>`)}}else if(p.type==="product_list"){const I=Array.from(document.querySelectorAll("#selected-products-list .selected-product-item")).map(f=>{const v=M.find(q=>q.code===f.dataset.code);if(v){const q=he(v.name);return`<li>${v.code} ${v.name}: <b>${f.dataset.qty} ${q}</b></li>`}return null}).filter(Boolean),b=document.getElementById(`sub-items-container-fide${p.id}_pleksi`),T=b?Array.from(b.querySelectorAll('input[type="text"]')).filter(f=>!f.classList.contains("completed")).map(f=>`<li>${f.value}</li>`):[];I.length>0&&(S+=`<b><i>Sipariş verilmesi gerekenler:</i></b><ul>${I.join("")}</ul>`),T.length>0&&(S+=`<b><i>Pleksiyle sergilenmesi gerekenler veya Yanlış Pleksi malzeme ile kullanılanlar:</i></b><ul>${T.join("")}</ul>`)}else if(p.type==="pop_system"){const I=Array.from(document.querySelectorAll(".pop-checkbox:checked")).map(b=>b.value).filter(b=>!K.includes(b));I.length>0&&(S=`<ul><li>${I.join(", ")}</li></ul>`)}if(S!==""||F){const I=F?' <span style="background-color:#dcfce7; color:#166534; font-weight:bold; padding: 1px 6px; border-radius: 4px;">Tamamlandı</span>':"";let b=p.wantsStoreEmail&&p.type!=="pop_system"?l:"";p.type==="pop_system"&&p.popEmailTo&&p.popEmailTo.length>0&&(b=` <a href="mailto:${p.popEmailTo.join(",")}" style="background-color:#e0f2f7; color:#005f73; font-weight:bold; padding: 1px 6px; border-radius: 4px; text-decoration:none;">@${p.popEmailTo.join(", ")}</a>`),u+=`<p><b>FiDe ${p.id}. ${p.title}</b>${I}${b}</p>`,(!F||p.type==="product_list"||F&&p.type==="standard"&&S!=="")&&(u+=S)}});const c=new Date().getFullYear(),d=new Date().getMonth()+1;let g=Array.from({length:d},(p,B)=>`<th style="border: 1px solid #dddddd; text-align: center; padding: 6px; background-color: #f2f2f2; font-weight: bold; white-space: nowrap;">${Be[B+1]||B+1}</th>`).join(""),m=Array.from({length:d},(p,B)=>`<td style="border: 1px solid #dddddd; text-align: center; padding: 6px; white-space: nowrap;">${n.scores[B+1]||"-"}</td>`).join(""),y=Array.from({length:d},(p,B)=>`<td style="border: 1px solid #dddddd; text-align: center; padding: 6px; white-space: nowrap;">${i&&i.scores&&i.scores[B+1]!==void 0?i.scores[B+1]:"-"}</td>`).join("");const w=`<div style="overflow-x: auto;"><table style="border-collapse: collapse; margin-top: 10px; font-size: 10pt; border: 1px solid #dddddd;"><thead><tr><th style="border: 1px solid #dddddd; text-align: center; padding: 6px; background-color: #f2f2f2; font-weight: bold;">${c}</th>${g}</tr></thead><tbody><tr><td style="border: 1px solid #dddddd; text-align: left; padding: 6px; font-weight: bold;">DiDe</td>${m}</tr><tr><td style="border: 1px solid #dddddd; text-align: left; padding: 6px; font-weight: bold;">FiDe</td>${y}</tr></tbody></table></div>`;let _=e.replace(/{YONETMEN_ADI}/g,o||"Yetkili").replace(/{BAYI_BILGISI}/g,`${h.bayiKodu} ${r}`).replace(/{DENETIM_ICERIGI}/g,u).replace(/{PUAN_TABLOSU}/g,w);document.getElementById("dide-upload-card").style.display="none",document.getElementById("form-content").style.display="none";const ie=document.getElementById("generate-email-btn");ie&&(ie.style.display="none");const O=document.createElement("div");O.id="email-draft-container",O.className="card",O.innerHTML=`<h2><a href="#" data-action="return-to-main" style="text-decoration: none; color: inherit;" title="Ana Sayfaya Dön"><i class="fas fa-arrow-left" style="margin-right: 10px;"></i></a><i class="fas fa-envelope-open-text"></i> Kopyalanacak E-posta Taslağı</h2><div id="email-draft-area" contenteditable="true" style="min-height: 500px; border: 1px solid #ccc; padding: 10px; margin-top: 10px; font-family: Aptos, sans-serif; font-size: 11pt;">${_}</div>`,document.querySelector(".container").appendChild(O)}function Re(e){if(!e){C(),$(!0);return}try{C();for(const t in e){let n=document.getElementById(`fide-item-${t}`);if(!n)continue;const i=e[t];if(i.removed?we(n.querySelector('[data-action="toggle-remove"]'),t,!1):i.completed&&xe(n.querySelector('[data-action="toggle-complete"]'),t,!1),i.dynamicInputs){const a=A.find(l=>String(l.id)===t);i.dynamicInputs.forEach(l=>{const o=a&&a.type==="product_list"?`fide${t}_pleksi`:`fide${t}`;te(o,l.text,l.completed,!1)})}i.selectedProducts&&i.selectedProducts.forEach(a=>ve(a.code,a.qty,!1)),i.selectedPops&&(i.selectedPops.forEach(a=>{const l=document.querySelector(`.pop-checkbox[value="${a}"]`);l&&(l.checked=!0)}),G())}$(!0)}catch(t){alert("Geçersiz rapor verisi!"),console.error("Rapor yükleme hatası:",t)}}function $(e){const t=document.getElementById("form-content");if(!t)return;t.querySelectorAll("button, input, select").forEach(i=>{i.disabled=!e});const n=document.getElementById("generate-email-btn");n&&(n.disabled=!e)}function ue(e){var t;const n=e.target.closest("[data-action]");if(!n)return;const i=n.dataset.action,a=(t=n.closest(".fide-item"))==null?void 0:t.id.split("-")[2];switch(i){case"add-input":te(n.dataset.containerId);break;case"toggle-complete":xe(n,a);break;case"toggle-remove":we(n,a);break;case"delete-item":We(n);break;case"toggle-input-complete":Ee(n);break;case"add-product":ve();break;case"pop-copy":Xe();break;case"pop-clear":Qe();break;case"pop-expired":Ze();break;case"pop-email":Je();break;case"return-to-main":e.preventDefault(),Ge();break}}function Ue(e){e.innerHTML="",me.forEach(t=>{const n=document.createElement("label");n.className="checkbox-label";const i=document.createElement("input");i.type="checkbox",i.value=t,i.className="pop-checkbox",i.addEventListener("change",()=>{G(),k()}),n.appendChild(i),n.appendChild(document.createTextNode(t)),e.appendChild(n)})}function We(e){const t=e.parentElement;if(t.classList.contains("is-deleting"))clearTimeout(t.dataset.deleteTimer),t.removeAttribute("data-delete-timer"),t.classList.remove("is-deleting"),e.querySelector("i").className="fas fa-trash",e.classList.remove("btn-warning"),e.classList.add("btn-danger");else{t.classList.add("is-deleting"),e.querySelector("i").className="fas fa-undo",e.classList.remove("btn-danger"),e.classList.add("btn-warning");const n=setTimeout(()=>{t.remove(),k()},4e3);t.dataset.deleteTimer=n}k()}function ve(e,t,n=!0){const i=document.getElementById("product-selector"),a=document.getElementById("product-qty"),l=e||i.value,o=t||a.value;if(!l||!o||o<1)return alert("Lütfen malzeme ve geçerli bir miktar girin.");const r=M.find(g=>g.code===l);if(!r){console.error("Ürün bulunamadı: ",l);return}const u=document.getElementById("selected-products-list");if(document.querySelector(`.selected-product-item[data-code="${r.code}"]`))return alert("Bu ürün zaten listede.");const c=he(r.name),d=document.createElement("div");d.className="selected-product-item",d.dataset.code=r.code,d.dataset.qty=o,d.innerHTML=`<span>${r.code} ${r.name} - <span class="product-quantity"><b>${o} ${c}</b></span></span><button class="delete-item-btn btn-sm" title="Bu malzemeyi sipariş listesinden siler."><i class="fas fa-trash"></i></button>`,d.querySelector(".delete-item-btn").addEventListener("click",function(){this.parentElement.remove(),k()}),u.appendChild(d),e||(i.value="",a.value="1"),n&&k()}function Ee(e){const t=e.parentElement.querySelector('input[type="text"]'),n=t.classList.toggle("completed");t.readOnly=n,e.innerHTML=n?'<i class="fas fa-undo"></i> Geri Al':'<i class="fas fa-check"></i> Tamamlandı',e.classList.toggle("undo",n),k()}function xe(e,t,n=!0){const i=document.getElementById(`fide-item-${t}`),a=i.querySelector(".fide-title-container").classList.toggle("question-completed");e.innerHTML=a?'<i class="fas fa-undo"></i> Geri Al':'<i class="fas fa-check"></i> Tamamlandı',e.classList.toggle("undo",a);const l=i.querySelector(".input-area");l&&(l.style.display=a?"none":"block"),n&&k()}function we(e,t,n=!0){const i=document.getElementById(`fide-item-${t}`),a=i.classList.toggle("question-removed"),l=i.querySelector(".input-area"),o=e.closest(".fide-actions");l&&(l.style.display=a?"none":"block"),e.innerHTML=a?'<i class="fas fa-undo"></i> Geri Al':'<i class="fas fa-times-circle"></i> Çıkar',e.classList.toggle("btn-danger",!a),e.classList.toggle("btn-primary",a),o&&o.querySelectorAll('[data-action="add-input"], [data-action="toggle-complete"]').forEach(r=>r.disabled=a),n&&k()}function te(e,t="",n=!1,i=!0){const a=document.getElementById(`sub-items-container-${e}`);if(!a)return;const l=document.createElement("div");l.className="dynamic-input-item",l.innerHTML=`<input type="text" placeholder="Eksikliği yazın..." value="${t}">
        <button class="status-btn btn-sm" data-action="toggle-input-complete" title="Bu eksikliği 'Tamamlandı' olarak işaretler."><i class="fas fa-check"></i> Tamamlandı</button>
        <button class="delete-bar btn-danger" data-action="delete-item" title="Bu satırı silmek için tıklayın."><i class="fas fa-trash"></i></button>`;const o=l.querySelector("input"),r=l.querySelector('[data-action="toggle-input-complete"]');o.addEventListener("keydown",u=>{u.key==="Enter"&&(u.preventDefault(),te(e))}),o.addEventListener("blur",()=>k()),n&&Ee(r),a.prepend(l),t===""&&o.focus(),i&&k()}function G(){const e=document.getElementById("expiredWarning");if(!e)return;const t=Array.from(document.querySelectorAll(".pop-checkbox:checked")).some(n=>K.includes(n.value));e.style.display=t?"block":"none"}function Xe(){const e=Array.from(document.querySelectorAll(".pop-checkbox:checked")).map(t=>t.value).filter(t=>!K.includes(t));if(e.length===0)return alert("Kopyalamak için geçerli kod seçin.");navigator.clipboard.writeText(e.join(", ")).then(()=>alert("Seçilen geçerli kodlar kopyalandı!"))}function Qe(){document.querySelectorAll(".pop-checkbox").forEach(e=>e.checked=!1),G(),k()}function Ze(){document.querySelectorAll(".pop-checkbox").forEach(e=>{e.checked=K.includes(e.value)}),G(),k()}function Je(){const e=Array.from(document.querySelectorAll(".pop-checkbox:checked")).map(o=>o.value).filter(o=>!K.includes(o));if(e.length===0){alert("E-Posta göndermek için geçerli (süresi dolmamış) kod seçin.");return}const t=A.find(o=>o.type==="pop_system")||{},n=(t.popEmailTo||[]).join(","),i=(t.popEmailCc||[]).join(","),a=`<!DOCTYPE html><html><head><title>E-Posta Taslağı</title></head><body><div>Kime: ${n}</div><div>CC: ${i}</div><div>Konu: (Boş)</div><div>İçerik:<br>${e.join(", ")}</div></body></html>`,l=window.open("","_blank");l.document.write(a),l.document.close()}function et(e){const t=document.getElementById("store-list");t.innerHTML="",e.forEach(n=>{const i=document.createElement("div");i.className="store-item";let a=n.bayiAdi;a&&a.length>20&&(a=a.substring(0,20)+"..."),i.textContent=`${a} (${n.bayiKodu})`,i.dataset.bayiKodu=n.bayiKodu,i.addEventListener("click",()=>{tt(n)}),t.appendChild(i)})}async function tt(e,t=!0){if(Z.includes(String(e.bayiKodu))&&!confirm(`UYARI: Bu bayi (${e.bayiAdi} - ${e.bayiKodu}) bu ay içinde zaten denetlenmiş.

Rapora devam edebilirsiniz ancak bu işlem aylık denetim sayınızı ARTTIRMAYACAKTIR.

Yine de devam etmek istiyor musunuz?`))return;document.querySelectorAll(".store-item").forEach(l=>l.classList.remove("selected"));const n=document.querySelector(`.store-item[data-bayi-kodu="${e.bayiKodu}"]`);n&&n.classList.add("selected"),ee({bayiKodu:e.bayiKodu,bayiAdi:e.bayiAdi});const i=document.getElementById("store-search-input");let a=e.bayiAdi.length>20?e.bayiAdi.substring(0,20)+"...":e.bayiAdi;if(i.value=`${e.bayiKodu} - ${a}`,document.getElementById("store-list").innerHTML="",document.getElementById("store-list").style.display="none",t){const l=await Oe(e.bayiKodu);l?Re(l):C()}else C();$(!0)}let D;window.onload=it;async function it(){D=new PocketBase(POCKETBASE_URL),De(D),Fe(D),Ye(D),at(),D.authStore.isValid?(oe(!0),de(),await Ce()&&(W(),X.length>0&&(document.getElementById("store-selection-area").style.display="block",document.getElementById("clear-excel-btn").style.display="inline-flex"),Q.length>0&&(document.getElementById("clear-fide-excel-btn").style.display="inline-flex")),ze()):(oe(!1),de(),W(),$(!1)),nt(),h||$(!1)}function nt(){if(document.body.dataset.listenersAttached)return;document.body.dataset.listenersAttached="true";const e=document.getElementById("login-toggle-btn"),t=document.getElementById("logout-btn"),n=document.getElementById("login-popup"),i=document.getElementById("login-submit-btn");e.addEventListener("click",r=>{r.stopPropagation(),n.style.display=n.style.display==="block"?"none":"block"}),t.addEventListener("click",()=>{E(),window.location.reload()}),i.addEventListener("click",async()=>{const r=document.getElementById("email-input").value,u=document.getElementById("password-input").value,c=document.getElementById("login-error");if(c.textContent="",!r||!u){c.textContent="Lütfen tüm alanları doldurun.";return}const d=await be(r,u);d.success?window.location.reload():c.textContent=d.message}),window.addEventListener("click",r=>{!n.contains(r.target)&&r.target!==e&&(n.style.display="none")}),document.getElementById("excel-file-input").addEventListener("change",async r=>{await se(r,"dide")&&(document.getElementById("store-selection-area").style.display="block",document.getElementById("clear-excel-btn").style.display="inline-flex")}),document.getElementById("fide-excel-file-input").addEventListener("change",async r=>{await se(r,"fide")&&(document.getElementById("clear-fide-excel-btn").style.display="inline-flex")}),document.getElementById("new-report-btn").addEventListener("click",je),document.getElementById("clear-excel-btn").addEventListener("click",()=>{confirm("Yüklenmiş olan DiDe Excel verisini buluttan silmek istediğinizden emin misiniz?")&&re("dide")}),document.getElementById("clear-fide-excel-btn").addEventListener("click",()=>{confirm("Yüklenmiş olan FiDe Excel verisini buluttan silmek istediğinizden emin misiniz?")&&re("fide")}),document.getElementById("store-search-input").addEventListener("keyup",r=>{ee(null),z(null),$(!1);const u=r.target.value.toLowerCase().trim(),c=document.getElementById("store-list");if(c.style.display="block",u===""){c.innerHTML="";return}const d=N.filter(g=>g.bayiAdi&&g.bayiAdi.toLowerCase().includes(u)||g.bayiKodu&&String(g.bayiKodu).toLowerCase().includes(u));et(d)}),document.getElementById("toggle-backup-manager-btn").addEventListener("click",()=>{window.open("admin/admin.html","_blank")});const a=document.getElementById("generate-email-btn");a&&a.addEventListener("click",Ve);const l=document.getElementById("form-content");l&&l.addEventListener("click",ue);const o=document.querySelector(".container");o&&o.addEventListener("click",ue)}function at(){const e=document.getElementById("login-toggle-btn"),t=document.getElementById("logout-btn");D.authStore.isValid?(e.style.display="none",t.style.display="inline-flex"):(e.style.display="inline-flex",t.style.display="none")}
