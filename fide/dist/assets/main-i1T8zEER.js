import{P as Be}from"./db-config-DOJnS-mV.js";let W=[],X=[],O=[],_=[],N=[],ye=[],z=[],fe={},Z=[],h=null,V=null,J=!1;const oe=[{id:0,type:"standard",title:"HATA: Sorular buluttan yüklenemedi."}],Se=["","Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];function pe(e){W=e}function ge(e){X=e}function Le(e){O=e}function j(e){_=e}function De(e){N=e}function $e(e){ye=e}function Ae(e){z=e}function Ce(e){fe=e}function le(e){Z=e}function ee(e){h=e}function K(e){V=e}function se(e){J=e}function H(e){const t=document.getElementById("loading-overlay");if(t){const i=t.querySelector("i");i&&(i.className="fas fa-spinner fa-spin",i.style.fontSize="",i.style.marginBottom="");const n=t.querySelector("p");n.textContent=e,n.style.textAlign="",n.style.padding="",n.style.maxWidth="",n.style.boxSizing="",n.style.wordWrap="",n.style.overflowWrap="",n.style.width="",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.color="white",t.style.flexDirection="column",t.style.justifyContent="center",t.style.alignItems="center",t.style.display="flex"}}function Y(){const e=document.getElementById("loading-overlay");e&&(e.style.display="none")}function P(e){const t=document.getElementById("loading-overlay");if(t){const i=t.querySelector("i");i&&(i.className="fas fa-lock",i.style.fontSize="40px",i.style.marginBottom="20px");const n=t.querySelector("p");n.textContent=e,n.style.width="90%",n.style.maxWidth="90%",n.style.textAlign="center",n.style.padding="0",n.style.boxSizing="border-box",n.style.wordWrap="break-word",n.style.overflowWrap="break-word",t.style.backgroundColor="rgba(255, 0, 0, 0.7)",t.style.color="white",t.style.flexDirection="column",t.style.justifyContent="center",t.style.alignItems="center",t.style.display="flex",t.style.zIndex="2000"}}let c;function Te(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function _e(){const e=navigator.userAgent;let t="Unknown OS",i="Unknown Browser";return/Windows/.test(e)?t="Windows":/Macintosh/.test(e)?t="MacOS":/iPhone|iPad|iPod/.test(e)?t="iOS":/Android/.test(e)?t="Android":/Linux/.test(e)&&(t="Linux"),/Edg/.test(e)?i="Edge":/Chrome/.test(e)&&!/Edg/.test(e)?i="Chrome":/Safari/.test(e)&&!/Chrome/.test(e)?i="Safari":/Firefox/.test(e)&&(i="Firefox"),`${i} on ${t}`}function Ke(){const e=new Uint32Array(4);return window.crypto.getRandomValues(e),Array.from(e,t=>t.toString(36)).join("-").toUpperCase()}function ze(e){c=e}async function Re(){if(!c||!c.authStore.isValid)return;const e=c.authStore.model.id,t=localStorage.getItem("myAppDeviceKey");try{if((await c.collection("users").getOne(e)).is_banned===!0){console.warn("Hesap zaten kilitli. Oturum sonlandırılıyor."),P("Hesabınız bir yönetici tarafından kilitlenmiştir. Sistemden çıkış yapılıyor..."),x(),setTimeout(()=>window.location.reload(),3e3);return}c.collection("users").subscribe(e,function(n){n.record&&n.record.is_banned===!0&&(console.warn("Kullanıcı kilitlendi (is_banned=true). Oturum sonlandırılıyor."),P("Hesabınız bir yönetici tarafından kilitlenmiştir. Sistemden çıkış yapılıyor..."),x(),setTimeout(()=>window.location.reload(),3e3))})}catch(i){console.error("Kullanıcı (ban) dinlemesi başlatılamadı:",i)}if(c.authStore.model.role==="client"&&t)try{const i=await c.collection("user_devices").getFirstListItem(`user="${e}" && device_key="${t}"`);if(i.is_locked===!0){console.warn("Cihaz zaten kilitli. Oturum sonlandırılıyor."),P("Bu cihaz bir yönetici tarafından kilitlenmiştir. Sistemden çıkış yapılıyor..."),x(),setTimeout(()=>window.location.reload(),3e3);return}c.collection("user_devices").subscribe(i.id,function(n){n.record&&n.record.is_locked===!0&&(console.warn("Cihaz kilitlendi (is_locked=true). Oturum sonlandırılıyor."),P("Bu cihaz bir yönetici tarafından kilitlenmiştir. Sistemden çıkış yapılıyor..."),x(),setTimeout(()=>window.location.reload(),3e3))})}catch(i){console.error("Cihaz (lock) dinlemesi başlatılamadı veya cihaz kaydı bulunamadı:",i),P("Cihaz kaydınız bulunamadı veya geçersiz. Güvenlik nedeniyle çıkış yapılıyor..."),x(),localStorage.removeItem("myAppDeviceKey"),setTimeout(()=>window.location.reload(),3e3)}}async function Pe(){if(le([]),!(!c||!c.authStore.isValid))try{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1).toISOString().split("T")[0]+" 00:00:00",i=`${e.getFullYear()}-${e.getMonth()}`;let n=[];try{n=(await c.collection("denetim_geri_alinanlar").getFullList({filter:`yil_ay = "${i}"`,expand:"bayi"})).map(r=>r.expand&&r.expand.bayi?r.expand.bayi.bayiKodu:null).filter(Boolean)}catch(s){s.status!==404&&console.error("Geri alınan bayi bilgisi yüklenemedi:",s)}const l=(await c.collection("denetim_raporlari").getFullList({filter:`denetimTamamlanmaTarihi >= "${t}"`,expand:"bayi"})).map(s=>s.expand.bayi.bayiKodu).filter(s=>!n.includes(s));le(l)}catch(e){console.error("Bu ay denetlenen bayi verileri yüklenirken hata oluştu:",e)}}async function Fe(){if(!(!c||!c.authStore.isValid)){try{const e=await c.collection("excel_verileri").getFirstListItem('tip="dide"');e&&(e.dosyaAdi&&(document.getElementById("file-name").textContent=`Buluttan yüklendi: ${e.dosyaAdi}`),pe(e.veri))}catch(e){e.status!==404&&console.error("Buluttan DiDe Excel verisi yüklenirken hata oluştu:",e)}try{const e=await c.collection("excel_verileri").getFirstListItem('tip="fide"');e&&(e.dosyaAdi&&(document.getElementById("fide-file-name").textContent=`Buluttan yüklendi: ${e.dosyaAdi}`),ge(e.veri))}catch(e){e.status!==404&&console.error("Buluttan FiDe Excel verisi yüklenirken hata oluştu:",e)}}}async function Me(){if(!c||!c.authStore.isValid)return j(oe),!1;H("Veriler yükleniyor...");try{await Pe();const t=(await c.collection("ayarlar").getFullList()).find(a=>a.anahtar==="fideQuestionsData");if(t){const a=t.deger;j(a.questions||[]),De(a.productList||[])}else throw new Error("fideQuestionsData bulunamadı");const i=_.find(a=>a.type==="pop_system");i&&($e(i.popCodes||[]),Ae(i.expiredCodes||[]));const n=await c.collection("bayiler").getFullList({sort:"bayiAdi"});Le(n);const o={};return n.forEach(a=>{a.email&&(o[a.bayiKodu]=a.email)}),Ce(o),await Fe(),!0}catch(e){return console.error("Başlangıç verileri okunurken hata oluştu:",e),j(oe),document.getElementById("initialization-error").style.display="block",!1}finally{Y()}}async function be(e,t=!1){if(!h||!c||!c.authStore.isValid)return;const i=String(h.bayiKodu),n=O.find(l=>l.bayiKodu===i);if(!n){console.error("Kaydedilecek bayi veritabanında bulunamadı!");return}if(t)try{const l=new Date,s=`${l.getFullYear()}-${l.getMonth()}`,r=await c.collection("denetim_geri_alinanlar").getFirstListItem(`yil_ay="${s}" && bayi="${n.id}"`);await c.collection("denetim_geri_alinanlar").delete(r.id)}catch(l){l.status!==404&&console.error("Geri alınmış denetim kaydı temizlenirken bir hata oluştu:",l)}const o={bayi:n.id,soruDurumlari:e.questions_status,user:c.authStore.model.id},a=Z.includes(i);t&&!a&&(o.denetimTamamlanmaTarihi=new Date().toISOString()),t&&H("Rapor kaydediliyor...");try{if(V)await c.collection("denetim_raporlari").update(V,o);else{const l=await c.collection("denetim_raporlari").create(o);K(l.id)}}catch(l){console.error("PocketBase'e yazma hatası:",l),t&&alert("Rapor kaydedilirken bir hata oluştu!")}finally{t&&Y()}}async function Oe(e){if(!c||!c.authStore.isValid)return null;H("Rapor yükleniyor...");try{const t=O.find(n=>n.bayiKodu===e);if(!t)throw new Error("Bayi bulunamadı.");const i=await c.collection("denetim_raporlari").getFirstListItem(`bayi="${t.id}"`,{sort:"-created"});return K(i.id),i.soruDurumlari}catch(t){return t.status===404?(console.log("Bu bayi için kaydedilmiş bir rapor bulunamadı. Temiz form açılıyor."),K(null)):console.error("PocketBase'den rapor okuma hatası:",t),null}finally{Y()}}async function re(e){if(!c.authStore.isValid){alert("Bu işlem için giriş yapmış olmalısınız.");return}try{const t=await c.collection("excel_verileri").getFirstListItem(`tip="${e}"`);await c.collection("excel_verileri").delete(t.id),alert(`${e.toUpperCase()} Excel verisi buluttan temizlendi. Sayfa yenileniyor.`),window.location.reload()}catch(t){t.status===404?alert(`Silinecek ${e.toUpperCase()} verisi bulunamadı.`):(console.error(`${e.toUpperCase()} verisi silinirken bir hata oluştu:`,t),alert("Veri silinirken bir hata oluştu."))}}async function he(e,t){if(!c)return{success:!1,message:"Veritabanı bağlantısı kurulamadı."};let i;try{const n=await c.collection("users").authWithPassword(e,t);i=await c.collection("users").getOne(n.record.id)}catch(n){return console.error("Login error:",n),{success:!1,message:"E-posta veya şifre hatalı."}}try{if(i.is_banned===!0)return x(),{success:!1,message:"Bu hesap yönetici tarafından kilitlenmiştir."};if(i.role==="admin")return{success:!0,message:"Yönetici girişi başarılı."};if(i.mobile_access===!1&&Te())return x(),{success:!1,message:"Bu hesaptan mobil cihaz ile giriş izni yoktur."};const n=localStorage.getItem("myAppDeviceKey"),o=_e();if(n)try{const a=await c.collection("user_devices").getFirstListItem(`user="${i.id}" && device_key="${n}"`);return a.is_locked?(x(),{success:!1,message:"Bu cihaz yönetici tarafından kilitlenmiştir."}):(await c.collection("user_devices").update(a.id,{last_login:new Date().toISOString(),device_info:o}),{success:!0,message:"Giriş başarılı."})}catch{return localStorage.removeItem("myAppDeviceKey"),he(e,t)}else{const a=i.device_limit||1;if((await c.collection("user_devices").getFullList({filter:`user="${i.id}"`})).length>=a)return x(),{success:!1,message:`Kişisel cihaz limitiniz (${a}) dolmuştur. Yeni bir cihaz ekleyemezsiniz. Lütfen yöneticinizle iletişime geçin.`};const s=Ke();return await c.collection("user_devices").create({user:i.id,device_key:s,device_info:o,last_login:new Date().toISOString(),is_locked:!1}),localStorage.setItem("myAppDeviceKey",s),{success:!0,message:"Yeni cihaz kaydedildi ve giriş yapıldı."}}}catch(n){return console.error("Login security check error:",n),x(),{success:!1,message:"Güvenlik kontrolü sırasında bir hata oluştu."}}}function x(){c&&c.authStore.clear()}let I;function Ne(e){I=e}async function He(e,t){if(e.length<2)return alert("DiDe Excel dosyası beklenen formatta değil (en az 2 satır gerekli)."),null;let i=e.findIndex(u=>u.some(m=>typeof m=="string"&&m.trim()==="Bayi Kodu"));if(i===-1)return alert('DiDe Excel dosyasında "Bayi Kodu" içeren bir başlık satırı bulunamadı.'),null;const n=e[i].map(u=>typeof u=="string"?u.trim():u),o=e.slice(i+1),a=n.indexOf("Bayi Kodu"),l=n.indexOf("Bayi"),s=n.indexOf("Bayi Yönetmeni");if([a,l,s].includes(-1))return alert('DiDe Excel dosyasında "Bayi Kodu", "Bayi" veya "Bayi Yönetmeni" sütunlarından biri bulunamadı.'),null;const r=o.map(u=>{if(!u[a])return null;const m={};return n.forEach((g,v)=>{const d=parseInt(g);!isNaN(d)&&d>=1&&d<=12&&u[v]!==null&&u[v]!==void 0&&(m[d]=u[v])}),{"Bayi Kodu":u[a],Bayi:u[l],"Bayi Yönetmeni":u[s],scores:m}}).filter(u=>u);if(I&&I.authStore.isValid){const u={tip:"dide",dosyaAdi:t,veri:r};try{const m=await I.collection("excel_verileri").getFirstListItem('tip="dide"');await I.collection("excel_verileri").update(m.id,u)}catch(m){if(m.status===404)await I.collection("excel_verileri").create(u);else return console.error("DiDe verisi kaydedilirken hata:",m),alert("DiDe verisi buluta kaydedilirken bir hata oluştu."),null}alert("DiDe puan dosyası başarıyla işlendi ve buluta kaydedildi.")}return r}async function Ye(e,t){if(e.length<3)return alert("FiDe Excel dosyası beklenen formatta değil (en az 3 satır gerekli)."),null;const i=new Date().getFullYear();let n=-1;for(let d=0;d<e.length;d++)if(e[d].some(p=>String(p).trim()==i)){n=d;break}if(n===-1)return alert(`FiDe Excel dosyasında '${i}' yılını içeren bir satır bulunamadı.`),null;const a=e[n].reduce((d,p)=>(d.lastKnown=p!=null&&String(p).trim()!==""?String(p).trim():d.lastKnown,d.result.push(d.lastKnown),d),{result:[],lastKnown:null}).result;let l=n+1;if(l>=e.length)return alert("FiDe Excel dosyasında ay bilgileri (yıl satırının altında) bulunamadı."),null;const s=e[l];let r=e.findIndex(d=>d.some(p=>typeof p=="string"&&p.trim()==="Bayi Kodu"));if(r===-1)return alert('FiDe Excel dosyasında "Bayi Kodu" içeren bir başlık satırı bulunamadı.'),null;const u=e[r].map(d=>typeof d=="string"?d.trim():d),m=e.slice(r+1),g=u.indexOf("Bayi Kodu");if(g===-1)return alert('FiDe Excel dosyasında "Bayi Kodu" sütunu bulunamadı.'),null;const v=m.map(d=>{if(!d[g])return null;const p={};for(let w=0;w<a.length;w++)if(a[w]==i){const $=parseInt(s[w]);!isNaN($)&&$>=1&&$<=12&&d[w]!==null&&d[w]!==void 0&&d[w]!==""&&(p[$]=d[w])}return{"Bayi Kodu":d[g],scores:p}}).filter(d=>d);if(I&&I.authStore.isValid){const d={tip:"fide",dosyaAdi:t,veri:v};try{const p=await I.collection("excel_verileri").getFirstListItem('tip="fide"');await I.collection("excel_verileri").update(p.id,d)}catch(p){if(p.status===404)await I.collection("excel_verileri").create(d);else return console.error("FiDe verisi kaydedilirken hata:",p),alert("FiDe verisi buluta kaydedilirken bir hata oluştu."),null}alert("FiDe puan dosyası başarıyla işlendi ve buluta kaydedildi.")}return v}async function de(e,t){const i=e.target.files[0];if(!i)return!1;const n=i.name,o=t==="dide"?document.getElementById("file-name"):document.getElementById("fide-file-name");return o.textContent=`Yüklü dosya: ${n}`,H("Excel dosyası işleniyor..."),new Promise(a=>{const l=new FileReader;l.readAsArrayBuffer(i),l.onload=async function(s){try{const r=new Uint8Array(s.target.result),u=XLSX.read(r,{type:"array"}),m=u.SheetNames[0],g=u.Sheets[m],v=XLSX.utils.sheet_to_json(g,{header:1,defval:""});let d;t==="dide"?(d=await He(v,n),d&&pe(d)):(d=await Ye(v,n),d&&ge(d)),a(!!d)}catch(r){alert("Excel dosyası okunurken bir hata oluştu."),console.error("Excel okuma hatası:",r),a(!1)}finally{Y()}},l.onerror=()=>{alert("Dosya okunamadı."),a(!1)}})}let C,ce;function k(){clearTimeout(ce),ce=setTimeout(()=>{J&&h&&be(ve())},800)}function qe(e){C=e}function ke(e){const t=e.toUpperCase();return t.includes("TSHIRT")||t.includes("HIRKA")?"Adet":"Paket"}function Ue(e){let t="",i="",n=e.isArchived?"archived-item":"";if(e.type==="standard"){t=`<div class="fide-actions">
            <button class="add-item-btn btn-sm" data-action="add-input" data-container-id="fide${e.id}" title="Bu maddeyle ilgili yeni bir eksiklik satırı ekler."><i class="fas fa-plus"></i> Yeni Eksik Ekle</button>
            <button class="status-btn btn-sm" data-action="toggle-complete" data-question-id="${e.id}" title="Bu soruyu 'Tamamlandı' olarak işaretler. Geri alınabilir."><i class="fas fa-check"></i> Tamamlandı</button>
            <button class="remove-btn btn-danger btn-sm" data-action="toggle-remove" data-question-id="${e.id}" title="Bu soruyu e-posta raporundan tamamen çıkarır. Geri alınabilir."><i class="fas fa-times-circle"></i> Çıkar</button>
            </div>`;let o=(e.staticItems||[]).map(a=>`<div class="static-item"><div class="content">${a}</div><button class="delete-bar btn-danger" data-action="delete-item" title="Bu satırı silmek için tıklayın. 4 saniye içinde geri alınabilir."><i class="fas fa-trash"></i></button></div>`).join("");i=`<div class="input-area"><div id="sub-items-container-fide${e.id}">${o}</div></div>`}else if(e.type==="product_list"){t=`<div class="fide-actions">
            <button class="add-item-btn btn-sm" data-action="add-input" data-container-id="fide${e.id}_pleksi" title="Pleksi kullanımıyla ilgili yeni bir eksiklik satırı ekler."><i class="fas fa-plus"></i> Yeni Ekle</button>
            <button class="status-btn btn-sm" data-action="toggle-complete" data-question-id="${e.id}" title="Bu soruyu 'Tamamlandı' olarak işaretler. Geri alınabilir."><i class="fas fa-check"></i> Tamamlandı</button>
            <button class="remove-btn btn-danger btn-sm" data-action="toggle-remove" data-question-id="${e.id}" title="Bu soruyu e-posta raporundan tamamen çıkarır. Geri alınabilir."><i class="fas fa-times-circle"></i> Çıkar</button>
            </div>`;let o="",a=!1;N.forEach(l=>{l.type==="header"?(a&&(o+="</optgroup>"),o+=`<optgroup label="${l.name}">`,a=!0):o+=`<option value="${l.code}">${l.code} - ${l.name}</option>`}),a&&(o+="</optgroup>"),i=`<div class="input-area"><b><i>Sipariş verilmesi gerekenler:</i></b>
            <div class="product-adder">
                <select id="product-selector"><option value="">-- Malzeme Seçin --</option>${o}</select>
                <input type="number" id="product-qty" placeholder="Adet" min="1" value="1">
                <button class="btn-success btn-sm" data-action="add-product" title="Seçili malzemeyi ve adedini aşağıdaki sipariş listesine ekler."><i class="fas fa-plus"></i> Ekle</button>
            </div>
            <div id="selected-products-list"></div><hr><b class="plexi-header"><i>Pleksiyle sergilenmesi gerekenler veya Yanlış Pleksi malzeme ile kullanılanlar:</i></b>
            <div id="sub-items-container-fide${e.id}_pleksi"></div></div>`}else e.type==="pop_system"&&(t=`<div class="fide-actions">
            <button class="status-btn btn-sm" data-action="toggle-complete" data-question-id="${e.id}" title="Bu soruyu 'Tamamlandı' olarak işaretler. Geri alınabilir."><i class="fas fa-check"></i> Tamamlandı</button>
            <button class="remove-btn btn-danger btn-sm" data-action="toggle-remove" data-question-id="${e.id}" title="Bu soruyu e-posta raporundan tamamen çıkarır. Geri alınabilir."><i class="fas fa-times-circle"></i> Çıkar</button>
            </div>`,i=`<div class="input-area"><div class="pop-container" id="popCodesContainer"></div><div class="warning-message" id="expiredWarning">Seçiminizde süresi dolmuş kodlar bulunmaktadır.</div>
            <div class="pop-button-container">
                <button class="btn-success btn-sm" data-action="pop-copy" title="Seçili olan geçerli POP kodlarını panoya kopyalar.">Kopyala</button>
                <button class="btn-danger btn-sm" data-action="pop-clear" title="Tüm POP kodu seçimlerini temizler.">Temizle</button>
                <button class="btn-primary btn-sm" data-action="pop-expired" title="Süresi dolmuş olan tüm POP kodlarını otomatik olarak seçer.">Bitenler</button>
                <button class="btn-primary btn-sm" data-action="pop-email" title="Seçili POP kodları için bir e-posta taslağı penceresi açar.">E-Posta</button>
            </div></div>`);return`<div class="fide-item ${n}" id="fide-item-${e.id}"><div class="fide-title-container"><p><span class="badge">FiDe ${e.id}</span> ${e.title}</p></div>${i}${t}</div>`}function ve(){let e={questions_status:{}};return _.forEach(t=>{const i=document.getElementById(`fide-item-${t.id}`);if(!i)return;const n=i.classList.contains("question-removed"),o=i.querySelector(".fide-title-container"),a=o?o.classList.contains("question-completed"):!1,l={removed:n,completed:a,dynamicInputs:[],selectedProducts:[],selectedPops:[]};if(t.type==="standard"){const s=document.getElementById(`sub-items-container-fide${t.id}`);s&&Array.from(s.childNodes).reverse().forEach(r=>{if(r.classList&&r.classList.contains("dynamic-input-item")){const u=r.querySelector('input[type="text"]'),m=u.value.trim();m&&l.dynamicInputs.push({text:m,completed:u.classList.contains("completed")})}})}else if(t.type==="product_list"){document.querySelectorAll(`#fide-item-${t.id} #selected-products-list .selected-product-item`).forEach(r=>{l.selectedProducts.push({code:r.dataset.code,qty:r.dataset.qty})});const s=document.getElementById(`sub-items-container-fide${t.id}_pleksi`);s&&Array.from(s.childNodes).reverse().forEach(r=>{if(r.classList&&r.classList.contains("dynamic-input-item")){const u=r.querySelector('input[type="text"]'),m=u.value.trim();m&&l.dynamicInputs.push({text:m,completed:u.classList.contains("completed")})}})}else t.type==="pop_system"&&(l.selectedPops=Array.from(document.querySelectorAll(`#fide-item-${t.id} .pop-checkbox:checked`)).map(s=>s.value));e.questions_status[t.id]=l}),e}function ue(){const e=document.getElementById("connection-status-switch"),t=document.getElementById("connection-status-text"),i=J&&typeof C<"u"&&C&&C.authStore.isValid;e.classList.toggle("connected",i),e.classList.toggle("disconnected",!i),t.textContent=i?"Buluta Bağlı":"Bağlı Değil"}function Ge(){const e=document.getElementById("email-draft-container");e&&e.remove(),document.getElementById("dide-upload-card").style.display="block",document.getElementById("form-content").style.display="block";const t=document.getElementById("generate-email-btn");t&&(t.style.display="block")}function F(){K(null);const e=document.getElementById("form-content");e&&(e.innerHTML=""),Q()}function Q(){const e=document.getElementById("form-content");if(!e)return;e.innerHTML="";let t="";_.forEach(n=>{n.isArchived||(t+=Ue(n))}),e.innerHTML=t;const i=document.getElementById("popCodesContainer");i&&We(i)}function je(){ee(null),K(null);const e=document.getElementById("store-search-input");e&&(e.value=""),F(),T(!1)}async function Ve(){if(!h){alert("Lütfen denetime başlamadan önce bir bayi seçin!");return}let e="<p>{YONETMEN_ADI} Bey Merhaba,</p><p>Ziyaret etmiş olduğum {BAYI_BILGISI} bayi karnesi aşağıdadır.</p><p><br></p>{DENETIM_ICERIGI}<p><br></p>{PUAN_TABLOSU}";if(C&&C.authStore.isValid)try{const y=await C.collection("ayarlar").getFirstListItem('anahtar="emailTemplate"');y&&y.deger&&(e=y.deger)}catch(y){y.status!==404&&console.error("E-posta şablonu buluttan yüklenemedi.",y)}const t=ve();await be(t,!0);const i=W.find(y=>String(y["Bayi Kodu"])===String(h.bayiKodu)),n=X.find(y=>String(y["Bayi Kodu"])===String(h.bayiKodu));if(!i){alert("Seçilen bayi için DiDe verisi bulunamadı. Lütfen DiDe Excel dosyasını yükleyin.");return}const o=fe[h.bayiKodu]||null,a=o?` <a href="mailto:${o}" style="background-color:#e0f2f7; color:#005f73; font-weight:bold; padding: 1px 6px; border-radius: 4px; text-decoration:none;">@${o}</a>`:"",l=(i["Bayi Yönetmeni"]||"").split(" ")[0],s=h.bayiAdi.length>20?h.bayiAdi.substring(0,20)+"...":h.bayiAdi;let r="";_.forEach(y=>{var ie;const E=document.getElementById(`fide-item-${y.id}`);if(!E||E.classList.contains("question-removed"))return;const R=(ie=E.querySelector(".fide-title-container"))==null?void 0:ie.classList.contains("question-completed");let A="";if(y.type==="standard"){const B=document.getElementById(`sub-items-container-fide${y.id}`);if(B){const b=[];Array.from(B.childNodes).reverse().forEach(f=>{if(f.classList&&(f.classList.contains("static-item")||f.classList.contains("dynamic-input-item"))){if(f.classList.contains("is-deleting"))return;let L,ne=!1,G="";if(f.classList.contains("static-item"))L=f.querySelector(".content").innerHTML,G="static";else{const ae=f.querySelector('input[type="text"]');L=ae.value.trim(),ne=ae.classList.contains("completed"),G="dynamic"}L&&b.push({text:L,completed:ne,type:G})}});let S=b.some(f=>f.type==="dynamic")?b.filter(f=>f.type==="dynamic"||f.type==="static"&&f.text.includes("<a href")):b.filter(f=>f.type==="static");S.length>0&&(S.sort((f,L)=>(f.text.includes("<a href")?1:-1)-(L.text.includes("<a href")?1:-1)),A=`<ul>${S.map(f=>f.completed?`<li>${f.text} <span style="background-color:#dcfce7; color:#166534; font-weight:bold; padding: 1px 6px; border-radius: 4px;">Tamamlandı</span></li>`:`<li>${f.text}</li>`).join("")}</ul>`)}}else if(y.type==="product_list"){const B=Array.from(document.querySelectorAll("#selected-products-list .selected-product-item")).map(S=>{const f=N.find(L=>L.code===S.dataset.code);if(f){const L=ke(f.name);return`<li>${f.code} ${f.name}: <b>${S.dataset.qty} ${L}</b></li>`}return null}).filter(Boolean),b=document.getElementById(`sub-items-container-fide${y.id}_pleksi`),U=b?Array.from(b.querySelectorAll('input[type="text"]')).filter(S=>!S.classList.contains("completed")).map(S=>`<li>${S.value}</li>`):[];B.length>0&&(A+=`<b><i>Sipariş verilmesi gerekenler:</i></b><ul>${B.join("")}</ul>`),U.length>0&&(A+=`<b><i>Pleksiyle sergilenmesi gerekenler veya Yanlış Pleksi malzeme ile kullanılanlar:</i></b><ul>${U.join("")}</ul>`)}else if(y.type==="pop_system"){const B=Array.from(document.querySelectorAll(".pop-checkbox:checked")).map(b=>b.value).filter(b=>!z.includes(b));B.length>0&&(A=`<ul><li>${B.join(", ")}</li></ul>`)}if(A!==""||R){const B=R?' <span style="background-color:#dcfce7; color:#166534; font-weight:bold; padding: 1px 6px; border-radius: 4px;">Tamamlandı</span>':"";let b=y.wantsStoreEmail&&y.type!=="pop_system"?a:"";y.type==="pop_system"&&y.popEmailTo&&y.popEmailTo.length>0&&(b=` <a href="mailto:${y.popEmailTo.join(",")}" style="background-color:#e0f2f7; color:#005f73; font-weight:bold; padding: 1px 6px; border-radius: 4px; text-decoration:none;">@${y.popEmailTo.join(", ")}</a>`),r+=`<p><b>FiDe ${y.id}. ${y.title}</b>${B}${b}</p>`,(!R||y.type==="product_list"||R&&y.type==="standard"&&A!=="")&&(r+=A)}});const u=new Date().getFullYear(),m=new Date().getMonth()+1;let g=Array.from({length:m},(y,E)=>`<th style="border: 1px solid #dddddd; text-align: center; padding: 6px; background-color: #f2f2f2; font-weight: bold; white-space: nowrap;">${Se[E+1]||E+1}</th>`).join(""),v=Array.from({length:m},(y,E)=>`<td style="border: 1px solid #dddddd; text-align: center; padding: 6px; white-space: nowrap;">${i.scores[E+1]||"-"}</td>`).join(""),d=Array.from({length:m},(y,E)=>`<td style="border: 1px solid #dddddd; text-align: center; padding: 6px; white-space: nowrap;">${n&&n.scores&&n.scores[E+1]!==void 0?n.scores[E+1]:"-"}</td>`).join("");const p=`<div style="overflow-x: auto;"><table style="border-collapse: collapse; margin-top: 10px; font-size: 10pt; border: 1px solid #dddddd;"><thead><tr><th style="border: 1px solid #dddddd; text-align: center; padding: 6px; background-color: #f2f2f2; font-weight: bold;">${u}</th>${g}</tr></thead><tbody><tr><td style="border: 1px solid #dddddd; text-align: left; padding: 6px; font-weight: bold;">DiDe</td>${v}</tr><tr><td style="border: 1px solid #dddddd; text-align: left; padding: 6px; font-weight: bold;">FiDe</td>${d}</tr></tbody></table></div>`;let w=e.replace(/{YONETMEN_ADI}/g,l||"Yetkili").replace(/{BAYI_BILGISI}/g,`${h.bayiKodu} ${s}`).replace(/{DENETIM_ICERIGI}/g,r).replace(/{PUAN_TABLOSU}/g,p);document.getElementById("dide-upload-card").style.display="none",document.getElementById("form-content").style.display="none";const $=document.getElementById("generate-email-btn");$&&($.style.display="none");const M=document.createElement("div");M.id="email-draft-container",M.className="card",M.innerHTML=`<h2><a href="#" data-action="return-to-main" style="text-decoration: none; color: inherit;" title="Ana Sayfaya Dön"><i class="fas fa-arrow-left" style="margin-right: 10px;"></i></a><i class="fas fa-envelope-open-text"></i> Kopyalanacak E-posta Taslağı</h2><div id="email-draft-area" contenteditable="true" style="min-height: 500px; border: 1px solid #ccc; padding: 10px; margin-top: 10px; font-family: Aptos, sans-serif; font-size: 11pt;">${w}</div>`,document.querySelector(".container").appendChild(M)}function Qe(e){if(!e){F(),T(!0);return}try{F();for(const t in e){let i=document.getElementById(`fide-item-${t}`);if(!i)continue;const n=e[t];if(n.removed?we(i.querySelector('[data-action="toggle-remove"]'),t,!1):n.completed&&Ie(i.querySelector('[data-action="toggle-complete"]'),t,!1),n.dynamicInputs){const o=_.find(a=>String(a.id)===t);n.dynamicInputs.forEach(a=>{const l=o&&o.type==="product_list"?`fide${t}_pleksi`:`fide${t}`;te(l,a.text,a.completed,!1)})}n.selectedProducts&&n.selectedProducts.forEach(o=>Ee(o.code,o.qty,!1)),n.selectedPops&&(n.selectedPops.forEach(o=>{const a=document.querySelector(`.pop-checkbox[value="${o}"]`);a&&(a.checked=!0)}),q())}T(!0)}catch(t){alert("Geçersiz rapor verisi!"),console.error("Rapor yükleme hatası:",t)}}function T(e){const t=document.getElementById("form-content");if(!t)return;t.querySelectorAll("button, input, select").forEach(n=>{n.disabled=!e});const i=document.getElementById("generate-email-btn");i&&(i.disabled=!e)}function me(e){var a;const i=e.target.closest("[data-action]");if(!i)return;const n=i.dataset.action,o=(a=i.closest(".fide-item"))==null?void 0:a.id.split("-")[2];switch(n){case"add-input":te(i.dataset.containerId);break;case"toggle-complete":Ie(i,o);break;case"toggle-remove":we(i,o);break;case"delete-item":Xe(i);break;case"toggle-input-complete":xe(i);break;case"add-product":Ee();break;case"pop-copy":Ze();break;case"pop-clear":Je();break;case"pop-expired":et();break;case"pop-email":tt();break;case"return-to-main":e.preventDefault(),Ge();break}}function We(e){e.innerHTML="",ye.forEach(t=>{const i=document.createElement("label");i.className="checkbox-label";const n=document.createElement("input");n.type="checkbox",n.value=t,n.className="pop-checkbox",n.addEventListener("change",()=>{q(),k()}),i.appendChild(n),i.appendChild(document.createTextNode(t)),e.appendChild(i)})}function Xe(e){const t=e.parentElement;if(t.classList.contains("is-deleting"))clearTimeout(t.dataset.deleteTimer),t.removeAttribute("data-delete-timer"),t.classList.remove("is-deleting"),e.querySelector("i").className="fas fa-trash",e.classList.remove("btn-warning"),e.classList.add("btn-danger");else{t.classList.add("is-deleting"),e.querySelector("i").className="fas fa-undo",e.classList.remove("btn-danger"),e.classList.add("btn-warning");const i=setTimeout(()=>{t.remove(),k()},4e3);t.dataset.deleteTimer=i}k()}function Ee(e,t,i=!0){const n=document.getElementById("product-selector"),o=document.getElementById("product-qty"),a=e||n.value,l=t||o.value;if(!a||!l||l<1)return alert("Lütfen malzeme ve geçerli bir miktar girin.");const s=N.find(g=>g.code===a);if(!s){console.error("Ürün bulunamadı: ",a);return}const r=document.getElementById("selected-products-list");if(document.querySelector(`.selected-product-item[data-code="${s.code}"]`))return alert("Bu ürün zaten listede.");const u=ke(s.name),m=document.createElement("div");m.className="selected-product-item",m.dataset.code=s.code,m.dataset.qty=l,m.innerHTML=`<span>${s.code} ${s.name} - <span class="product-quantity"><b>${l} ${u}</b></span></span><button class="delete-item-btn btn-sm" title="Bu malzemeyi sipariş listesinden siler."><i class="fas fa-trash"></i></button>`,m.querySelector(".delete-item-btn").addEventListener("click",function(){this.parentElement.remove(),k()}),r.appendChild(m),e||(n.value="",o.value="1"),i&&k()}function xe(e){const t=e.parentElement.querySelector('input[type="text"]'),i=t.classList.toggle("completed");t.readOnly=i,e.innerHTML=i?'<i class="fas fa-undo"></i> Geri Al':'<i class="fas fa-check"></i> Tamamlandı',e.classList.toggle("undo",i),k()}function Ie(e,t,i=!0){const n=document.getElementById(`fide-item-${t}`),a=n.querySelector(".fide-title-container").classList.toggle("question-completed");e.innerHTML=a?'<i class="fas fa-undo"></i> Geri Al':'<i class="fas fa-check"></i> Tamamlandı',e.classList.toggle("undo",a);const l=n.querySelector(".input-area");l&&(l.style.display=a?"none":"block"),i&&k()}function we(e,t,i=!0){const n=document.getElementById(`fide-item-${t}`),o=n.classList.toggle("question-removed"),a=n.querySelector(".input-area"),l=e.closest(".fide-actions");a&&(a.style.display=o?"none":"block"),e.innerHTML=o?'<i class="fas fa-undo"></i> Geri Al':'<i class="fas fa-times-circle"></i> Çıkar',e.classList.toggle("btn-danger",!o),e.classList.toggle("btn-primary",o),l&&l.querySelectorAll('[data-action="add-input"], [data-action="toggle-complete"]').forEach(s=>s.disabled=o),i&&k()}function te(e,t="",i=!1,n=!0){const o=document.getElementById(`sub-items-container-${e}`);if(!o)return;const a=document.createElement("div");a.className="dynamic-input-item",a.innerHTML=`<input type="text" placeholder="Eksikliği yazın..." value="${t}">
        <button class="status-btn btn-sm" data-action="toggle-input-complete" title="Bu eksikliği 'Tamamlandı' olarak işaretler."><i class="fas fa-check"></i> Tamamlandı</button>
        <button class="delete-bar btn-danger" data-action="delete-item" title="Bu satırı silmek için tıklayın."><i class="fas fa-trash"></i></button>`;const l=a.querySelector("input"),s=a.querySelector('[data-action="toggle-input-complete"]');l.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),te(e))}),l.addEventListener("blur",()=>k()),i&&xe(s),o.prepend(a),t===""&&l.focus(),n&&k()}function q(){const e=document.getElementById("expiredWarning");if(!e)return;const t=Array.from(document.querySelectorAll(".pop-checkbox:checked")).some(i=>z.includes(i.value));e.style.display=t?"block":"none"}function Ze(){const e=Array.from(document.querySelectorAll(".pop-checkbox:checked")).map(t=>t.value).filter(t=>!z.includes(t));if(e.length===0)return alert("Kopyalamak için geçerli kod seçin.");navigator.clipboard.writeText(e.join(", ")).then(()=>alert("Seçilen geçerli kodlar kopyalandı!"))}function Je(){document.querySelectorAll(".pop-checkbox").forEach(e=>e.checked=!1),q(),k()}function et(){document.querySelectorAll(".pop-checkbox").forEach(e=>{e.checked=z.includes(e.value)}),q(),k()}function tt(){const t=Array.from(document.querySelectorAll(".pop-checkbox:checked")).map(s=>s.value).filter(s=>!z.includes(s));if(t.length===0){alert("E-Posta göndermek için geçerli (süresi dolmamış) kod seçin.");return}const i=_.find(s=>s.type==="pop_system")||{},n=(i.popEmailTo||[]).join(","),o=(i.popEmailCc||[]).join(","),a=`<!DOCTYPE html><html><head><title>E-Posta Taslağı</title></head><body><div>Kime: ${n}</div><div>CC: ${o}</div><div>Konu: (Boş)</div><div>İçerik:<br>${t.join(", ")}</div></body></html>`,l=window.open("","_blank");l.document.write(a),l.document.close()}function it(e){const t=document.getElementById("store-list");t.innerHTML="",e.forEach(i=>{const n=document.createElement("div");n.className="store-item";let o=i.bayiAdi;o&&o.length>20&&(o=o.substring(0,20)+"..."),n.textContent=`${o} (${i.bayiKodu})`,n.dataset.bayiKodu=i.bayiKodu,n.addEventListener("click",()=>{nt(i)}),t.appendChild(n)})}async function nt(e,t=!0){if(Z.includes(String(e.bayiKodu))&&!confirm(`UYARI: Bu bayi (${e.bayiAdi} - ${e.bayiKodu}) bu ay içinde zaten denetlenmiş.

Rapora devam edebilirsiniz ancak bu işlem aylık denetim sayınızı ARTTIRMAYACAKTIR.

Yine de devam etmek istiyor musunuz?`))return;document.querySelectorAll(".store-item").forEach(a=>a.classList.remove("selected"));const i=document.querySelector(`.store-item[data-bayi-kodu="${e.bayiKodu}"]`);i&&i.classList.add("selected"),ee({bayiKodu:e.bayiKodu,bayiAdi:e.bayiAdi});const n=document.getElementById("store-search-input");let o=e.bayiAdi.length>20?e.bayiAdi.substring(0,20)+"...":e.bayiAdi;if(n.value=`${e.bayiKodu} - ${o}`,document.getElementById("store-list").innerHTML="",document.getElementById("store-list").style.display="none",t){const a=await Oe(e.bayiKodu);a?Qe(a):F()}else F();T(!0)}let D;window.onload=at;async function at(){try{D=new PocketBase(Be)}catch(e){console.error("PocketBase başlatılamadı. Adresin doğru olduğundan emin olun.",e)}ze(D),Ne(D),qe(D),lt(),D&&D.authStore.isValid?(se(!0),ue(),await Me()&&(Q(),W.length>0&&(document.getElementById("store-selection-area").style.display="block",document.getElementById("clear-excel-btn").style.display="inline-flex"),X.length>0&&(document.getElementById("clear-fide-excel-btn").style.display="inline-flex")),Re()):(se(!1),ue(),Q(),T(!1)),ot(),h||T(!1)}function ot(){if(document.body.dataset.listenersAttached)return;document.body.dataset.listenersAttached="true";const e=document.getElementById("login-toggle-btn"),t=document.getElementById("logout-btn"),i=document.getElementById("login-popup"),n=document.getElementById("login-submit-btn");e.addEventListener("click",s=>{s.stopPropagation(),i.style.display=i.style.display==="block"?"none":"block"}),t.addEventListener("click",()=>{x(),window.location.reload()}),n.addEventListener("click",async()=>{const s=document.getElementById("email-input").value,r=document.getElementById("password-input").value,u=document.getElementById("login-error");if(u.textContent="",!s||!r){u.textContent="Lütfen tüm alanları doldurun.";return}const m=await he(s,r);m.success?window.location.reload():u.textContent=m.message}),window.addEventListener("click",s=>{i&&!i.contains(s.target)&&s.target!==e&&(i.style.display="none")}),document.getElementById("excel-file-input").addEventListener("change",async s=>{await de(s,"dide")&&(document.getElementById("store-selection-area").style.display="block",document.getElementById("clear-excel-btn").style.display="inline-flex")}),document.getElementById("fide-excel-file-input").addEventListener("change",async s=>{await de(s,"fide")&&(document.getElementById("clear-fide-excel-btn").style.display="inline-flex")}),document.getElementById("new-report-btn").addEventListener("click",je),document.getElementById("clear-excel-btn").addEventListener("click",()=>{confirm("Yüklenmiş olan DiDe Excel verisini buluttan silmek istediğinizden emin misiniz?")&&re("dide")}),document.getElementById("clear-fide-excel-btn").addEventListener("click",()=>{confirm("Yüklenmiş olan FiDe Excel verisini buluttan silmek istediğinizden emin misiniz?")&&re("fide")}),document.getElementById("store-search-input").addEventListener("keyup",s=>{ee(null),K(null),T(!1);const r=s.target.value.toLowerCase().trim(),u=document.getElementById("store-list");if(u.style.display="block",r===""){u.innerHTML="";return}const m=O.filter(g=>g.bayiAdi&&g.bayiAdi.toLowerCase().includes(r)||g.bayiKodu&&String(g.bayiKodu).toLowerCase().includes(r));it(m)}),document.getElementById("toggle-backup-manager-btn").addEventListener("click",()=>{window.open("admin/admin.html","_blank")});const o=document.getElementById("generate-email-btn");o&&o.addEventListener("click",Ve);const a=document.getElementById("form-content");a&&a.addEventListener("click",me);const l=document.querySelector(".container");l&&l.addEventListener("click",me)}function lt(){const e=document.getElementById("login-toggle-btn"),t=document.getElementById("logout-btn");D&&D.authStore.isValid?(e.style.display="none",t.style.display="inline-flex"):(e.style.display="inline-flex",t.style.display="none")}
